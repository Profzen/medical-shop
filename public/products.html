<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Produits • MedicalShop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Products page - inline CSS (blue/white/green palette) - adjusted for thumbnails & cart button - responsive improvements */
    :root{
      --bg: #f4f9ff;
      --nav-bg: #0b355f;
      --accent-blue: #1f6feb;
      --accent-green: #1fb67a;
      --accent-green-2: #22c55e;
      --card-bg: #ffffff;
      --muted: #6b7b8f;
      --text: #032139;
      --panel-border: rgba(10,30,60,0.04);
      --radius:12px;
      --shadow: 0 12px 30px rgba(9,30,66,0.06);
      --glass: rgba(31,111,235,0.06);
      --max-width: 1200px;
      --header-height: 64px;
    }
    *{box-sizing:border-box}
    html,body{ height:100%; }
    body{ margin:0; font-family:Inter,system-ui,Roboto,Arial; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }
    a { color: inherit; text-decoration:none }
    .container{ max-width:var(--max-width); margin:0 auto; padding:18px; }

    /* Top nav */
    header{ background:var(--nav-bg); color:white; box-shadow:0 6px 18px rgba(2,6,23,0.08); position:sticky; top:0; z-index:90; }
    .header-inner{ display:flex; gap:12px; align-items:center; max-width:var(--max-width); margin:0 auto; padding:8px 18px; height:var(--header-height); align-items:center; }
    .brand-wrap{ display:flex; align-items:center; gap:12px; min-width:0; }
    .mark{ width:44px; height:44px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent-blue),var(--accent-green)); color:white; font-weight:900; flex-shrink:0; }
    nav.main{ margin-left:12px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    nav.main a{ color:rgba(255,255,255,0.95); padding:8px 10px; border-radius:8px; font-weight:600; white-space:nowrap; }
    nav.main a:hover{ background:rgba(255,255,255,0.04) }

    .nav-actions{ margin-left:auto; display:flex; gap:12px; align-items:center; min-width:0; }

    .search-box{ display:flex; gap:8px; align-items:center; min-width:0; }
    .search-box input{ padding:8px 10px; border-radius:8px; border:0; width:220px; background:rgba(255,255,255,0.12); color:white; outline:none; min-width:0; }
    .search-box input::placeholder{ color:rgba(255,255,255,0.8) }

    /* burger mobile */
    .nav-toggle{ display:none; background:transparent; border:0; color:white; font-size:22px; padding:8px; border-radius:8px; cursor:pointer }
    /* Modified: centered, not full-width mobile nav */
    .mobile-nav{
      display:none;
      position:fixed;
      top:calc(var(--header-height) + 10px);
      left:12px;
      right:12px;
      max-width:640px;
      margin:0 auto;
      background:linear-gradient(180deg,var(--nav-bg),#06304f);
      padding:16px;
      border-radius:12px;
      box-shadow:0 20px 60px rgba(2,8,23,0.28);
      z-index:995;
      border:1px solid rgba(255,255,255,0.04);
    }
    .mobile-nav a{ display:block; padding:10px 12px; border-radius:8px; color:white; font-weight:700; margin-bottom:6px }
    .mobile-actions{ display:flex; gap:8px; margin-top:8px; }

    /* Cart button like homepage */
    .cart-btn {
      position:relative;
      background: linear-gradient(135deg,var(--accent-blue),var(--accent-green));
      color:white;
      padding:8px 12px;
      border-radius:999px;
      display:flex;
      gap:8px;
      align-items:center;
      border:0;
      cursor:pointer;
      font-weight:700;
    }
    .cart-badge {
      position:absolute;
      right:-8px;
      top:-8px;
      background:#ff385c;
      color:white;
      font-weight:800;
      font-size:12px;
      padding:4px 7px;
      border-radius:999px;
      box-shadow:0 4px 8px rgba(0,0,0,0.12);
    }

    /* HERO */
    .hero{ padding:28px 18px; background:linear-gradient(180deg,#e6f2ff,#f8fbff); border-bottom:1px solid var(--panel-border) }
    .hero-inner{ max-width:var(--max-width); margin:0 auto; display:flex; gap:20px; align-items:center; padding:6px 18px; flex-wrap:wrap; }
    .hero-left{ flex:1; min-width:220px; }
    .kicker{ color:var(--accent-green); font-weight:800; margin-bottom:8px }
    h1{ margin:0; font-size:28px; color:var(--text) }
    p.lead{ margin-top:8px; color:var(--muted) }

    /* category filter strip */
    .cat-strip{ display:flex; gap:8px; padding:12px 0; overflow:auto; background:transparent; margin-top:16px; }
    .cat-btn{ white-space:nowrap; padding:8px 12px; border-radius:999px; background:white; border:1px solid var(--panel-border); cursor:pointer; font-weight:700; box-shadow:var(--shadow); }
    .cat-btn.active{ background:linear-gradient(90deg,var(--accent-blue),var(--accent-green)); color:white; border:0; box-shadow:0 10px 30px rgba(31,111,235,0.12) }

    /* controls */
    .controls{ max-width:var(--max-width); margin:18px auto 0; display:flex; gap:12px; padding:0 18px; align-items:center; flex-wrap:wrap; }
    .controls input, .controls select{ padding:10px 12px; border-radius:10px; border:1px solid var(--panel-border); background:white; color:var(--text) }
    .controls .spacer{ margin-left:auto }

    /* products grid */
    .products-grid{ max-width:var(--max-width); margin:18px auto; padding:12px 18px 48px; display:grid; grid-template-columns:repeat(4,1fr); gap:18px; }
    @media (max-width:1100px){ .products-grid{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width:800px){ .products-grid{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:520px){ .products-grid{ grid-template-columns:1fr; padding:12px; } }

    .card{ background:var(--card-bg); border-radius:12px; padding:12px; border:1px solid var(--panel-border); box-shadow:var(--shadow); display:flex; flex-direction:column; min-height:260px; overflow:hidden }
    /* thumb wrapper: ensures perfect centering and no crop */
    .thumb{ width:100%; height:150px; border-radius:8px; overflow:hidden; background:#f3f7fb; display:flex; align-items:center; justify-content:center; padding:8px }
    .thumb img{ max-width:100%; max-height:100%; object-fit:contain; display:block } /* contain, centered */
    .meta{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px }
    .title{ font-weight:800; font-size:15px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis }
    .price{ font-weight:900; color:var(--text) }
    .desc{ color:var(--muted); font-size:13px; margin-top:8px; min-height:36px; overflow:hidden; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical }
    .card .actions{ margin-top:auto; display:flex; gap:8px; flex-wrap:wrap; }

    .btn{ background:linear-gradient(135deg,var(--accent-blue),#3ea1ff); color:white; border:0; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:700 }
    .btn.ghost{ background:transparent; border:1px solid var(--panel-border); color:var(--text) }
    .btn-buy{ background:linear-gradient(135deg,var(--accent-green),var(--accent-green-2)); color:#042c1f; padding:10px 12px; border-radius:8px; border:0; font-weight:800; cursor:pointer }

    /* spinner (small) */
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(0,0,0,0.12); border-top-color: rgba(255,255,255,0.95); border-radius:50%; animation:spin 0.9s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* load more */
    .load-more-wrap{ display:flex; justify-content:center; margin:18px 0 48px; }
    .small{ font-size:13px; color:var(--muted) }

    /* product modal */
    .modal-backdrop{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,0.5); z-index:900; padding:12px; overflow:auto }
    .modal{ width:100%; max-width:920px; margin:0 auto; background:white; border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(2,8,23,0.2) }
    .preview-large{ width:100%; height:420px; background:#f5f8fb; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; padding:12px }
    .preview-large img{ max-width:100%; max-height:100%; object-fit:contain; display:block }

    /* cart panel */
    .cart-panel{ position:fixed; right:18px; bottom:18px; width:360px; max-width:calc(100% - 36px); background:white; border-radius:12px; box-shadow:0 20px 50px rgba(2,8,23,0.12); padding:12px; border:1px solid var(--panel-border); display:none; z-index:1000; }
    .cart-item{ display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid rgba(10,30,60,0.03) }
    .cart-thumb{ width:56px; height:56px; border-radius:8px; overflow:hidden; background:#f3f7fb; display:grid; place-items:center }
    .cart-thumb img{ max-width:100%; max-height:100%; object-fit:contain }

    /* buy modal */
    .buy-grid{ display:grid; grid-template-columns:1fr 260px; gap:12px; align-items:start }
    @media (max-width:820px){ .buy-grid{ grid-template-columns:1fr } }
    .qty-controls{ display:flex; gap:8px; align-items:center }
    .qty-controls button{ width:36px; height:36px; border-radius:8px; border:0; font-weight:700; cursor:pointer }
    .summary-box{ background:#fbfdff; padding:10px; border-radius:8px; border:1px solid rgba(10,30,60,0.03) }

    /* history modal */
    .hist-list{ display:flex; flex-direction:column; gap:10px; max-height:60vh; overflow:auto; padding-right:6px }
    .hist-row{ display:flex; gap:12px; align-items:center; padding:8px; border-radius:8px; background:rgba(15,23,42,0.02); border:1px solid rgba(10,30,60,0.03) }
    .mini-thumb{ width:72px; height:56px; border-radius:8px; overflow:hidden; background:#f3f7fb; display:grid; place-items:center }
    .mini-thumb img{ max-width:100%; max-height:100%; object-fit:contain }

    /* center options in history modal header on mobile */
    .history-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    @media (max-width:720px){
      .history-header { flex-direction:column; align-items:center; }
    }

    .center{ text-align:center }
    .diag { color:#ffb86b; margin-top:8px; font-size:13px }

    /* responsive adjustments */
    @media (max-width:900px){
      .header-inner{ padding:6px 12px; height:auto; gap:8px; align-items:center; }
      nav.main{ display:none; }
      .nav-toggle{ display:inline-flex; }
      .search-box input{ display:none; }
    }
    @media (max-width:720px){
      .cart-panel{ right:0; left:0; bottom:0; width:100%; border-radius:12px 12px 0 0; max-height:70vh; overflow:auto; padding-bottom:18px; }
      .hero-inner{ padding:12px; }
      .preview-large{ height:320px; }
      .modal{ margin:6px; padding:12px; max-width:980px; }
      .modal-backdrop{ align-items:start; padding-top:12px; }
      .search-box input { display:inline-block; width:120px; }
      /* history modal small screens: center & reduced size */
      #historyModal .modal {
        max-width: 320px !important;
        width: 90%;
        margin: 30px auto !important;
        padding: 12px;
      }
      #historyModal .hist-row { flex-direction:column; align-items:center; text-align:center; }
      #historyModal .hist-row .mini-thumb { margin-bottom:8px; }
    }

    /* small accessibility focus */
    .btn:focus, .cat-btn:focus, .nav-toggle:focus, .cart-btn:focus { outline:3px solid rgba(31,111,235,0.18); outline-offset:2px; }
  </style>
</head>
<body>
  <header>
    <div class="header-inner container" style="align-items:center;">
      <!-- Mobile: burger first, then logo, then nav (hidden on mobile), then search+cart on right -->
      <button id="navToggle" class="nav-toggle" aria-expanded="false" aria-controls="mobileNav" title="Menu">☰</button>

      <div class="brand-wrap" style="display:flex;align-items:center;gap:12px; min-width:0;">
        <a href="/" style="display:flex;align-items:center;gap:10px; color:white; text-decoration:none; min-width:0;">
          <div class="mark" aria-hidden="true">M+</div>
          <div style="line-height:1; min-width:0; overflow:hidden;">
            <div style="font-weight:800; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;">MedicalShop</div>
            <div style="font-size:12px; color:rgba(255,255,255,0.9); white-space:nowrap; overflow:hidden; text-overflow:ellipsis">Produits</div>
          </div>
        </a>
      </div>

      <nav class="main" aria-label="main nav">
        <a href="/">Accueil</a>
        <a href="/products.html">Produits</a>
        <a href="/about.html">À propos</a>
        <a href="/contact.html">Contact</a>
        <!-- Historique moved inside main nav -->
        <a id="navHistory" href="#" style="margin-left:6px; font-weight:700">Historique</a>
      </nav>

      <div class="nav-actions" role="toolbar" aria-label="navigation actions">
        <div class="search-box" role="search" aria-label="Recherche produits">
          <input id="searchInput" placeholder="Rechercher : gants, seringues..." aria-label="Recherche" />
        </div>

        <!-- cart button remains on the right -->
        <button id="cartBtn" class="cart-btn" title="Panier (0)" aria-haspopup="dialog" aria-controls="cartPanel">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:block"><path d="M3 3h2l.4 2M7 13h10l3-8H6.4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span id="cartCount" class="cart-badge" aria-live="polite" aria-atomic="true">0</span>
        </button>
      </div>
    </div>

    <div id="mobileNav" class="mobile-nav" aria-hidden="true">
      <a href="/">Accueil</a>
      <a href="/products.html">Produits</a>
      <a href="/about.html">À propos</a>
      <a href="/contact.html">Contact</a>
      <a id="mobileHistory" href="#" style="display:block; padding:10px 12px; color:white; font-weight:700">Historique</a>
      <div class="mobile-actions">
        <div style="flex:1"><input id="mobileSearch" placeholder="Rechercher..." style="width:100%; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.06); color:white"></div>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero" aria-labelledby="pageTitle">
    <div class="hero-inner">
      <div class="hero-left">
        <div class="kicker">Catalogue</div>
        <h1 id="pageTitle">Tous les produits</h1>
        <p class="lead">Parcourez notre catalogue professionnel — filtrez par catégorie, recherchez et commandez facilement.</p>

        <div id="catStripContainer" class="cat-strip" aria-hidden="false"></div>
      </div>
      <div style="width:280px; text-align:center; padding-right:18px;">
        <!-- image made to cover & fade edges (reduced size per request) -->
        <div style="width:100%; height:140px; border-radius:8px; overflow:hidden; position:relative; display:flex; align-items:center; justify-content:center;">
          <img id="heroImage" src="med.jpeg" alt="illustration" style="width:100%; height:100%; object-fit:cover; display:block; opacity:0.92; filter:contrast(1.02)" />
          <!-- soft right-side gradient for "fondu" effect -->
          <div style="position:absolute; right:0; top:0; bottom:0; width:28%; background:linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.24)); pointer-events:none"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- controls -->
  <div class="controls" role="toolbar" aria-label="Contrôles produits">
    <input id="q" placeholder="Recherche titre / SKU..." />
    <select id="sortBy" aria-label="Trier">
      <option value="created_desc">Tri: plus récent</option>
      <option value="price_asc">Prix : plus bas</option>
      <option value="price_desc">Prix : plus élevé</option>
    </select>
    <div class="spacer"></div>
    <div class="small">Chargement: <span id="loadedCount">0</span></div>
  </div>

  <!-- products grid -->
  <main>
    <div id="productsGrid" class="products-grid" aria-live="polite">
      <div class="placeholder">Chargement…</div>
    </div>

    <div class="load-more-wrap">
      <button id="btnLoadMore" class="btn ghost">Voir plus (+50)</button>
    </div>
  </main>

  <footer>
    <div class="footer-inner container" style="display:flex;justify-content:space-between;align-items:center;gap:12px;padding:18px 0">
      <div>
        <div style="font-weight:800">MedicalShop</div>
        <div class="small">Approvisionnement médical — qualité & rapidité</div>
      </div>
      <div class="small">support@medicalshop.tg — +228 90 00 00 00</div>
    </div>
  </footer>

  <!-- Product detail modal -->
  <div id="productModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-label="Détails produit">
    <div class="modal" role="document" aria-modal="true">
      <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
        <div style="flex:1 1 420px">
          <div class="preview-large" id="productLargePreview"><img src="/public/nbbcl.png" alt="img"></div>
        </div>
        <div style="width:320px; min-width:240px; display:flex; flex-direction:column; gap:12px;">
          <div>
            <h3 id="prodTitle" style="margin:0">Produit</h3>
            <div class="small muted" id="prodShort"></div>
            <div style="margin-top:8px; font-weight:800; font-size:18px" id="prodPrice">0 XOF</div>
            <div class="small muted" id="prodStock">Stock: 0</div>
          </div>

          <div style="display:flex; gap:8px; margin-top:12px">
            <button id="prodAddToCart" class="btn">Ajouter</button>
            <button id="prodBuyNow" class="btn-buy">Acheter</button>
            <button id="prodClose" class="btn ghost">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Buy modal (kept as before) -->
  <div id="buyModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-label="Modal commande">
    <div class="modal" role="document" aria-modal="true">
      <h3>Finaliser la commande</h3>
      <form id="buyForm">
        <div class="buy-grid" style="margin-top:12px">
          <div>
            <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap">
              <div style="flex:1; min-width:180px"><label class="small">Nom complet</label><input id="buyerName" required style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(10,30,60,0.06)"></div>
              <div style="width:180px; min-width:120px"><label class="small">Téléphone</label><input id="buyerPhone" required style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(10,30,60,0.06)"></div>
            </div>
            <div><label class="small">Adresse de livraison</label><input id="buyerAddress" required style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(10,30,60,0.06)"></div>

            <div style="margin-top:12px; display:flex; gap:8px; align-items:center; flex-wrap:wrap">
              <div class="qty-controls">
                <button type="button" id="qtyDec" class="btn ghost">-</button>
                <div id="qtyDisplay" style="min-width:36px; text-align:center; font-weight:700">1</div>
                <button type="button" id="qtyInc" class="btn">+</button>
              </div>
              <button id="submitOrder" class="btn-buy" type="submit">
                <span id="submitLabel">Valider la commande</span>
                <span id="submitSpinner" style="display:none; margin-left:8px;"><span class="spinner"></span></span>
              </button>
              <button id="cancelBuy" class="btn ghost" type="button">Annuler</button>
            </div>

            <div id="buyMsg" class="small muted" style="margin-top:8px"></div>
          </div>

          <div>
            <div class="small muted">Récapitulatif</div>
            <div id="buySummary" class="summary-box" style="margin-top:10px"></div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Cart panel -->
  <div id="cartPanel" class="cart-panel" aria-hidden="true" role="dialog" aria-label="Panier">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <strong>Panier</strong>
      <button id="btnCloseCart" class="btn ghost">Fermer</button>
    </div>
    <div id="cartList" style="max-height:340px; overflow:auto"></div>
    <div class="cart-footer" style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
      <div><strong>Total:</strong> <span id="cartTotal">0</span> XOF</div>
      <div>
        <button id="btnCheckout" class="btn-buy">Commander</button>
      </div>
    </div>
  </div>

  <!-- History modal (SEARCH & REFRESH REMOVED; VIEW/EXPORT removed; client -> product name) -->
  <div id="historyModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-label="Historique">
    <div class="modal" role="document" aria-modal="true">
      <div class="history-header" style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Historique local</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="histClose" class="btn ghost">Fermer</button>
        </div>
      </div>
      <div id="histList" class="hist-list" style="margin-top:12px"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const SUPABASE_URL = "https://vrzmowqzegmaymewmbij.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyem1vd3F6ZWdtYXltZXdtYmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDMwNzksImV4cCI6MjA3MDg3OTA3OX0.TmkdqXhkVgbfhAWVj-qLC9bDTL0-_YoGz-SgS81sNG0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM refs
    const productsGrid = document.getElementById('productsGrid');
    const catStripContainer = document.getElementById('catStripContainer');
    const qInput = document.getElementById('q');
    const sortBy = document.getElementById('sortBy');
    const btnLoadMore = document.getElementById('btnLoadMore');
    const loadedCountEl = document.getElementById('loadedCount');
    const searchInput = document.getElementById('searchInput');

    // New: history link in nav
    const navHistory = document.getElementById('navHistory');
    const mobileHistory = document.getElementById('mobileHistory');

    const productModal = document.getElementById('productModal');
    const productLargePreview = document.getElementById('productLargePreview');
    const prodTitle = document.getElementById('prodTitle');
    const prodShort = document.getElementById('prodShort');
    const prodPrice = document.getElementById('prodPrice');
    const prodStock = document.getElementById('prodStock');
    const prodAddToCart = document.getElementById('prodAddToCart');
    const prodBuyNow = document.getElementById('prodBuyNow');
    const prodClose = document.getElementById('prodClose');

    const buyModal = document.getElementById('buyModal');
    const buyForm = document.getElementById('buyForm');
    const buyerName = document.getElementById('buyerName');
    const buyerPhone = document.getElementById('buyerPhone');
    const buyerAddress = document.getElementById('buyerAddress');
    const qtyDec = document.getElementById('qtyDec');
    const qtyInc = document.getElementById('qtyInc');
    const qtyDisplay = document.getElementById('qtyDisplay');
    const buySummary = document.getElementById('buySummary');
    const submitOrderBtn = document.getElementById('submitOrder');
    const submitSpinner = document.getElementById('submitSpinner');
    const submitLabel = document.getElementById('submitLabel');
    const cancelBuy = document.getElementById('cancelBuy');
    const buyMsg = document.getElementById('buyMsg');

    const cartBtn = document.getElementById('cartBtn');
    const cartCountEl = document.getElementById('cartCount');
    const cartPanel = document.getElementById('cartPanel');
    const btnCloseCart = document.getElementById('btnCloseCart');
    const cartList = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');
    const btnCheckout = document.getElementById('btnCheckout');

    const historyModal = document.getElementById('historyModal');
    const histList = document.getElementById('histList');
    const histClose = document.getElementById('histClose');

    const navToggle = document.getElementById('navToggle');
    const mobileNav = document.getElementById('mobileNav');
    const mobileSearch = document.getElementById('mobileSearch');

    // state
    const PAGE_SIZE = 50;
    let offset = 0;
    let totalLoaded = 0;
    let currentCategory = '';
    let currentQuery = '';
    let currentSort = 'created_desc';
    let isLoading = false;
    let PRODUCTS = [];
    let CATEGORIES = [];
    let VIEWING_PRODUCT = null;
    const CART_KEY = 'ms_cart_v1';
    const HIST_KEY = 'ms_orders_history_v1';

    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function currencyFormat(n){ return Number(n||0).toLocaleString('fr-FR'); }

    // helper: close modals on backdrop click + Esc
    function setupModalShortcuts(){
      document.querySelectorAll('.modal-backdrop').forEach(back => {
        back.addEventListener('click', (e)=> {
          if (e.target === back) {
            back.style.display = 'none';
            back.setAttribute('aria-hidden','true');
          }
        });
      });
      document.addEventListener('keydown', (e)=> {
        if (e.key === 'Escape') {
          // close any open modal
          document.querySelectorAll('.modal-backdrop').forEach(m => { if (m.style.display === 'grid') { m.style.display = 'none'; m.setAttribute('aria-hidden','true'); } });
          // close mobile nav if open
          if (mobileNav && mobileNav.style.display === 'block') toggleMobileNav(false);
          if (cartPanel && getComputedStyle(cartPanel).display === 'block' && window.innerWidth <= 720) cartPanel.style.display = 'none';
        }
      });
    }

    // PART 1/2: fin — la suite (fonctions principales + événements + init) est dans la partie 2/2.
    // CART helpers
    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch(e){ return []; } }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartBadge(); }
    function updateCartBadge(){ const cart = loadCart(); const count = cart.reduce((s,i)=> s + (i.qty||0), 0); cartCountEl.textContent = String(count); }

    function renderCartPanel(){
      const cart = loadCart();
      cartList.innerHTML = '';
      if (cart.length === 0) { cartList.innerHTML = '<div class="small muted">Panier vide</div>'; cartTotalEl.textContent = '0'; return; }
      let total = 0;
      for (const item of cart) {
        total += (item.price || 0) * (item.qty || 1);
        const row = document.createElement('div'); row.className='cart-item';
        row.innerHTML = `<div class="cart-thumb"><img src="${escapeHtml(item.image_url || '/public/nbbcl.png')}" alt=""></div>
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(item.title)}</div>
            <div class="small muted">${currencyFormat(item.price)} XOF × ${item.qty}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <button class="btn ghost dec">-</button>
            <button class="btn ghost inc">+</button>
            <button class="btn ghost rem">✕</button>
          </div>`;
        row.querySelector('.dec').addEventListener('click', ()=> changeCartQty(item.productId, -1));
        row.querySelector('.inc').addEventListener('click', ()=> changeCartQty(item.productId, +1));
        row.querySelector('.rem').addEventListener('click', ()=> removeCartItem(item.productId));
        cartList.appendChild(row);
      }
      cartTotalEl.textContent = currencyFormat(total);
    }
    function changeCartQty(productId, delta){
      const cart = loadCart();
      const idx = cart.findIndex(i=> i.productId === productId);
      if (idx < 0) return;
      cart[idx].qty += delta;
      if (cart[idx].qty <= 0) cart.splice(idx,1);
      saveCart(cart);
      renderCartPanel();
    }
    function removeCartItem(productId){
      const cart = loadCart().filter(i => i.productId !== productId);
      saveCart(cart);
      renderCartPanel();
    }

    // HISTORY helpers
    function loadHistory(){ try { return JSON.parse(localStorage.getItem(HIST_KEY) || '[]'); } catch(e) { return []; } }
    function saveHistory(list){ localStorage.setItem(HIST_KEY, JSON.stringify(list)); }

    // IMAGE helpers
    async function resolveImageUrl(product){
      if (!product) return '/public/nbbcl.png';
      if (product.image_url) return product.image_url;
      if (product.image_path) {
        try {
          const { data } = supabase.storage.from('products').getPublicUrl(product.image_path);
          const publicUrl = data?.publicUrl || (data && data.publicURL) || null;
          if (publicUrl) {
            try { await supabase.from('products').update({ image_url: publicUrl }).eq('id', product.id); } catch(e){}
            return publicUrl;
          }
        } catch(e){ console.warn('getPublicUrl err', e); }
      }
      if (product.path) return product.path;
      if (product.img_url) return product.img_url;
      return '/public/nbbcl.png';
    }

    // robust product-by-ids
    async function fetchProductsByIds(ids){
      if (!ids || ids.length === 0) return [];
      const uniq = Array.from(new Set(ids.map(id => String(id))));
      try {
        const { data, error } = await supabase.from('products').select('id,title,price,stock,image_url,image_path,short_description').in('id', uniq);
        if (!error && data) return data;
        console.warn('.in() failed, falling back', error);
      } catch(e){ console.warn('fetchProductsByIds .in err', e); }
      const result = [];
      for (const id of uniq) {
        try {
          const { data, error } = await supabase.from('products').select('id,title,price,stock,image_url,image_path,short_description').eq('id', id).limit(1);
          if (!error && data && data.length) result.push(data[0]);
        } catch(e){ /* ignore per-id error */ }
      }
      return result;
    }

    // Render category strip
    function renderCategoryStrip(categories){
      catStripContainer.innerHTML = '';
      const allBtn = document.createElement('button');
      allBtn.className = 'cat-btn' + (currentCategory === '' ? ' active' : '');
      allBtn.textContent = 'Toutes';
      allBtn.addEventListener('click', ()=> { currentCategory = ''; resetAndLoad(); });
      catStripContainer.appendChild(allBtn);
      categories.forEach(c => {
        const b = document.createElement('button');
        b.className = 'cat-btn' + (String(c.id) === String(currentCategory) ? ' active' : '');
        b.textContent = c.name;
        b.addEventListener('click', ()=> {
          currentCategory = String(c.id);
          catStripContainer.querySelectorAll('.cat-btn').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          resetAndLoad();
        });
        catStripContainer.appendChild(b);
      });
    }

    // Product renderer
    async function renderProducts(list, append=false){
      if (!append) productsGrid.innerHTML = '';
      if (!list || list.length === 0) {
        if (!append) productsGrid.innerHTML = '<div class="placeholder">Aucun produit</div>';
        return;
      }
      for (const p of list) {
        const div = document.createElement('div'); div.className = 'card';
        const placeholder = '/public/nbbcl.png';
        div.innerHTML = `
          <div class="thumb"><img src="${escapeHtml(placeholder)}" alt="${escapeHtml(p.title)}" loading="lazy"></div>
          <div class="meta"><div style="min-width:0"><div class="title">${escapeHtml(p.title)}</div><div class="desc">${escapeHtml(p.short_description||'')}</div></div><div class="price">${currencyFormat(p.price)} XOF</div></div>
          <div class="small muted" style="margin-top:8px">Stock: ${p.stock ?? 0}</div>
          <div class="actions">
            <button class="btn view-btn">Voir</button>
            <button class="btn ghost add-btn">Ajouter</button>
            <button class="btn-buy buy-btn">Acheter</button>
          </div>
        `;
        productsGrid.appendChild(div);
        // progressively resolve image
        (async () => {
          const imgEl = div.querySelector('.thumb img');
          try {
            const url = await resolveImageUrl(p);
            if (url) imgEl.src = url;
          } catch(e){ console.warn('resolve image err', e); }
        })();

        // events
        div.querySelector('.add-btn').addEventListener('click', ()=> {
          const cart = loadCart();
          const idx = cart.findIndex(i => i.productId === p.id);
          if (idx >=0) cart[idx].qty += 1; else cart.push({ productId: p.id, qty:1, title:p.title, price:p.price, image_url: p.image_url || p.image_path || '/public/nbbcl.png' });
          saveCart(cart);
          renderCartPanel();
        });
        div.querySelector('.buy-btn').addEventListener('click', ()=> {
          openBuyModalWithProduct(p);
        });
        div.querySelector('.view-btn').addEventListener('click', ()=> {
          openProductModal(p);
        });
      }
    }

    // Open product modal (bigger image)
    async function openProductModal(p){
      VIEWING_PRODUCT = p;
      prodTitle.textContent = p.title || 'Produit';
      prodShort.textContent = p.short_description || p.description || '';
      prodPrice.textContent = `${currencyFormat(p.price)} XOF`;
      prodStock.textContent = `Stock: ${p.stock ?? 0}`;
      productLargePreview.innerHTML = `<img src="/public/nbbcl.png" alt="img">`;
      try {
        const url = await resolveImageUrl(p);
        if (url) productLargePreview.innerHTML = `<img src="${escapeHtml(url)}" alt="">`;
      } catch(e){ console.warn('openProductModal resolve image err', e); }
      prodAddToCart.onclick = () => { const cart = loadCart(); const idx = cart.findIndex(i => i.productId === p.id); if (idx >=0) cart[idx].qty += 1; else cart.push({ productId: p.id, qty:1, title:p.title, price:p.price, image_url: p.image_url || p.image_path || '/public/nbbcl.png' }); saveCart(cart); renderCartPanel(); closeProductModal(); };
      prodBuyNow.onclick = () => { openBuyModalWithProduct(p); };
      prodClose.onclick = closeProductModal;
      productModal.style.display = 'grid';
      productModal.setAttribute('aria-hidden','false');
    }
    function closeProductModal(){ productModal.style.display = 'none'; productModal.setAttribute('aria-hidden','true'); }

    // Buy modal logic
    let BUY_CONTEXT = { items: [], fromCart:false };
    function openBuyModalWithProduct(product){
      BUY_CONTEXT = { items: [{ productId: product.id, qty:1, title: product.title, price: Number(product.price||0), image_url: product.image_url || product.image_path || '/public/nbbcl.png' }], fromCart:false };
      populateBuySummary();
      qtyDisplay.textContent = String(BUY_CONTEXT.items[0].qty || 1);
      showBuyModal(true);
    }
    function openBuyModalFromCart(){
      const cart = loadCart();
      if (!cart || cart.length === 0) { alert('Panier vide'); return; }
      BUY_CONTEXT = { items: cart.map(i=>({ ...i })), fromCart:true };
      populateBuySummary();
      // when buying from cart, qty controls operate only for single-item quick updates — keep display 1 (as original)
      qtyDisplay.textContent = '1';
      showBuyModal(true);
    }
    function showBuyModal(show){
      buyModal.style.display = show ? 'grid' : 'none';
      buyModal.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (show) window.scrollTo({ top:0, behavior:'smooth' });
      buyMsg.textContent = '';
    }

    function populateBuySummary(){
      const items = BUY_CONTEXT.items || [];
      const lines = items.map(it => `<div style="display:flex;justify-content:space-between;margin-bottom:6px"><div>${escapeHtml(it.title)} ×${it.qty}</div><div>${currencyFormat((it.price||0)*it.qty)} XOF</div></div>`).join('');
      const total = items.reduce((s,i)=> s + (i.price||0)*(i.qty||0), 0);
      buySummary.innerHTML = `${lines}${lines ? '<hr style="border:none;border-top:1px solid rgba(10,30,60,0.06);margin:8px 0">' : ''}<div style="display:flex;justify-content:space-between"><strong>Total</strong><strong>${currencyFormat(total)} XOF</strong></div>`;
    }

    // ---- FIXED: qty increment/decrement MUST update qtyDisplay and buySummary ----
    qtyDec.addEventListener('click', ()=> {
      if (!BUY_CONTEXT.items || BUY_CONTEXT.items.length === 0) return;
      if (BUY_CONTEXT.items.length === 1) {
        if (BUY_CONTEXT.items[0].qty <= 1) return;
        BUY_CONTEXT.items[0].qty -= 1;
        qtyDisplay.textContent = String(BUY_CONTEXT.items[0].qty);
        populateBuySummary();
      }
    });
    qtyInc.addEventListener('click', ()=> {
      if (!BUY_CONTEXT.items || BUY_CONTEXT.items.length === 0) return;
      if (BUY_CONTEXT.items.length === 1) {
        BUY_CONTEXT.items[0].qty += 1;
        qtyDisplay.textContent = String(BUY_CONTEXT.items[0].qty);
        populateBuySummary();
      }
    });

    buyForm.addEventListener('submit', submitOrder);
    cancelBuy.addEventListener('click', ()=> showBuyModal(false));

    async function submitOrder(e){
      e && e.preventDefault();
      buyMsg.textContent = '';
      const name = buyerName.value.trim();
      const phone = buyerPhone.value.trim();
      const address = buyerAddress.value.trim();
      if (!name || !phone || !address) { buyMsg.textContent = 'Nom, téléphone et adresse requis'; return; }
      const items = (BUY_CONTEXT.items || []).map(it => ({ ...it }));
      if (!items || items.length === 0) { buyMsg.textContent = 'Aucun article'; return; }

      // show spinner and disable to prevent double submit
      submitOrderBtn.disabled = true;
      if (submitSpinner) submitSpinner.style.display = 'inline-block';
      if (submitLabel) submitLabel.style.opacity = '0.6';

      try {
        const total = items.reduce((s,i)=> s + (i.price||0)*(i.qty||0), 0);
        const order_number = `MS-${Date.now().toString(36).slice(-6).toUpperCase()}`;
        const orderPayload = {
          order_number,
          order_name: name,
          user_id: null,
          status: 'pending',
          payment_status: 'unpaid',
          total_amount: total,
          total: total,
          currency: 'XOF',
          shipping_address: address,
          phone: phone
        };

        const { data: orderData, error: orderErr } = await supabase.from('orders').insert([orderPayload]).select().single();
        if (orderErr) console.warn('order insert err', orderErr);
        const orderId = orderData?.id ?? null;

        const itemsPayload = items.map(it => ({
          order_id: orderId,
          product_id: it.productId,
          quantity: it.qty,
          price_at_order: it.price,
          status: 'pending',
          phone,
          order_number,
          order_name: name,
          shipping_address: address
        }));
        try { const { data: itemsRes, error: itemsErr } = await supabase.from('order_items').insert(itemsPayload).select(); if (itemsErr) console.warn('order_items insert err', itemsErr); } catch(err){ console.warn(err); }

        // store local history (prep meta identical à index)
        try {
          const hist = loadHistory();
          hist.unshift({
            id: orderId ?? `local-${Date.now()}`,
            order_number,
            order_name: name,
            phone,
            shipping_address: address,
            total,
            currency: 'XOF',
            status: 'pending',
            created_at: new Date().toISOString(),
            items: items.map(it => ({ productId: it.productId, title: it.title, qty: it.qty, price: it.price, image_url: it.image_url }))
          });
          saveHistory(hist);
        } catch(e){ console.warn('save local history err', e); }

        // --- NEW: SEND EMAIL VIA SERVER ENDPOINT (/api/send-email) ---
        // --- NEW: SEND EMAIL VIA SERVER ENDPOINT (/api/send-email) ---
        try {
          const emailMeta = {
            id: orderId,
            order_number,
            order_name: name,
            phone,
            shipping_address: address,
            total,
            currency: 'XOF'
          };
          // await to catch network errors (not required to block UX, but helpful)
          await fetch('/api/send-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ orderMeta: emailMeta, items })
          });
        } catch (e) {
          console.warn('send-email endpoint failed', e);
        }

        if (BUY_CONTEXT.fromCart) {
          localStorage.removeItem(CART_KEY);
          updateCartBadge();
          renderCartPanel();
        }
        flashMessage('Commande créée — #' + order_number);
        showBuyModal(false);
      } catch (err) {
        console.error('submitOrder err', err);
        buyMsg.textContent = 'Erreur envoi commande (voir console)';
      } finally {
        // hide spinner, re-enable
        if (submitSpinner) submitSpinner.style.display = 'none';
        if (submitLabel) submitLabel.style.opacity = '1';
        submitOrderBtn.disabled = false;
      }
    }

    function flashMessage(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.position = 'fixed';
      el.style.right = '18px';
      el.style.bottom = '90px';
      el.style.background = 'rgba(0,0,0,0.75)';
      el.style.color = 'white';
      el.style.padding = '10px 14px';
      el.style.borderRadius = '10px';
      el.style.zIndex = 1100;
      document.body.appendChild(el);
      setTimeout(()=> el.style.opacity = '0', 1600);
      setTimeout(()=> el.remove(), 2100);
    }

    // CART events
    cartBtn.addEventListener('click', ()=> {
      const visible = cartPanel.style.display === 'block' || getComputedStyle(cartPanel).display === 'block';
      if (!visible) { renderCartPanel(); cartPanel.style.display = 'block'; cartPanel.setAttribute('aria-hidden','false'); } else { cartPanel.style.display = 'none'; cartPanel.setAttribute('aria-hidden','true'); }
    });
    btnCloseCart.addEventListener('click', ()=> { cartPanel.style.display = 'none'; cartPanel.setAttribute('aria-hidden','true'); });
    btnCheckout.addEventListener('click', ()=> { openBuyModalFromCart(); cartPanel.style.display = 'none'; });

    // HISTORY events (search & refresh removed)
    function showHistoryModal(show){ historyModal.style.display = show ? 'grid' : 'none'; historyModal.setAttribute('aria-hidden', show ? 'false' : 'true'); if (show) renderHistoryList(); }
    navHistory.addEventListener('click', (e)=> { e.preventDefault(); showHistoryModal(true); });
    mobileHistory.addEventListener('click', (e)=> { e.preventDefault(); showHistoryModal(true); toggleMobileNav(false); });
    histClose.addEventListener('click', ()=> showHistoryModal(false));

    function renderHistoryList(){
      const hist = loadHistory() || [];
      histList.innerHTML = '';
      if (!hist.length) { histList.innerHTML = '<div class="small muted">Aucun historique</div>'; return; }
      hist.forEach(h => {
        const row = document.createElement('div'); row.className='hist-row';
        const firstImg = h.items && h.items[0] ? (h.items[0].image_url || '/public/nbbcl.png') : '/public/nbbcl.png';
        const when = new Date(h.created_at).toLocaleString();
        // Replace client name by product name (first item title). Remove view/export buttons.
        const productName = (h.items && h.items[0] && h.items[0].title) ? h.items[0].title : (h.order_name || '');
        row.innerHTML = `<div class="mini-thumb"><img src="${escapeHtml(firstImg)}" alt=""></div>
          <div style="flex:1">
            <div style="font-weight:800">${escapeHtml(h.order_number || String(h.id).slice(0,10))}</div>
            <div class="small muted">${escapeHtml(productName)} • ${escapeHtml(when)}</div>
            <div class="small muted">Total: ${currencyFormat(h.total)} ${escapeHtml(h.currency || 'XOF')}</div>
          </div>
          `;
        histList.appendChild(row);
      });
    }

    function showOrderFromHistory(rec){
      productLargePreview.innerHTML = `<img src="${escapeHtml(rec.items && rec.items[0] ? (rec.items[0].image_url || '/public/nbbcl.png') : '/public/nbbcl.png')}" alt="">`;
      prodTitle.textContent = `Commande ${rec.order_number || rec.id}`;
      prodShort.textContent = `Produit : ${rec.items && rec.items[0] ? (rec.items[0].title || '') : rec.order_name || ''}`;
      prodPrice.textContent = `${currencyFormat(rec.total)} ${rec.currency || 'XOF'}`;
      prodStock.textContent = `Articles: ${rec.items ? rec.items.length : 0}`;
      prodAddToCart.onclick = () => { alert('Action non disponible'); };
      prodBuyNow.onclick = () => { alert('Action non disponible'); };
      prodClose.onclick = closeProductModal;
      productModal.style.display = 'grid';
      productModal.setAttribute('aria-hidden','false');
    }

    // Load categories & products
    async function loadCategories(){
      try {
        const { data, error } = await supabase.from('categories').select('id,name').eq('is_active', true).order('name',{ ascending:true });
        if (!error && data) { CATEGORIES = data; renderCategoryStrip(CATEGORIES); } else { console.warn('categories err', error); renderCategoryStrip([]); }
      } catch(e){ console.warn('loadCategories err', e); renderCategoryStrip([]); }
    }

    function buildProductsQuery(qb){
      if (currentQuery) qb = qb.ilike('title', `%${currentQuery}%`);
      if (currentCategory) qb = qb.eq('category_id', currentCategory);
      if (currentSort === 'price_asc') qb = qb.order('price', { ascending:true });
      else if (currentSort === 'price_desc') qb = qb.order('price', { ascending:false });
      else qb = qb.order('created_at', { ascending:false });
      return qb;
    }

    async function loadProducts(append=false){
      if (isLoading) return;
      isLoading = true;
      if (!append) {
        offset = 0;
        totalLoaded = 0;
        productsGrid.innerHTML = '<div class="placeholder">Chargement…</div>';
      } else {
        btnLoadMore.textContent = 'Chargement…';
      }
      try {
        let qb = supabase.from('products').select('*').range(offset, offset + PAGE_SIZE - 1);
        qb = buildProductsQuery(qb);
        const { data, error } = await qb;
        if (error) {
          console.error('products fetch error', error);
          productsGrid.innerHTML = '<div class="placeholder">Erreur chargement (voir console)</div>';
          btnLoadMore.textContent = 'Voir plus (+50)';
          isLoading = false;
          return;
        }
        const items = data || [];
        if (!append) PRODUCTS = items.slice(); else PRODUCTS = PRODUCTS.concat(items);
        await renderProducts(items, append);
        offset += items.length;
        totalLoaded += items.length;
        loadedCountEl.textContent = String(totalLoaded);
        if (items.length < PAGE_SIZE) btnLoadMore.style.display = 'none'; else btnLoadMore.style.display = '';
      } catch (err) {
        console.error('loadProducts err', err);
        productsGrid.innerHTML = '<div class="placeholder">Erreur réseau</div>';
      } finally {
        btnLoadMore.textContent = 'Voir plus (+50)';
        isLoading = false;
      }
    }

    function resetAndLoad(){ offset = 0; totalLoaded = 0; loadProducts(false); }

    // search & events
    qInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { currentQuery = qInput.value.trim(); resetAndLoad(); }});
    searchInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { currentQuery = searchInput.value.trim(); resetAndLoad(); }});
    mobileSearch.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { currentQuery = mobileSearch.value.trim(); resetAndLoad(); toggleMobileNav(false); }});
    sortBy.addEventListener('change', ()=> { currentSort = sortBy.value; resetAndLoad(); });
    btnLoadMore.addEventListener('click', ()=> loadProducts(true));

    // mobile nav toggle
    function toggleMobileNav(show){
      if (!mobileNav) return;
      mobileNav.style.display = show ? 'block' : 'none';
      navToggle.setAttribute('aria-expanded', show ? 'true' : 'false');
      mobileNav.setAttribute('aria-hidden', show ? 'false' : 'true');
    }
    navToggle.addEventListener('click', ()=> {
      const open = mobileNav.style.display === 'block';
      toggleMobileNav(!open);
    });

    // init
    (async function init(){
      setupModalShortcuts();
      updateCartBadge();
      await loadCategories();
      await loadProducts(false);
    })();

    // debug helpers
    window._ms = { loadProducts, loadCategories, loadCart, loadHistory, resolveImageUrl, fetchProductsByIds };

  </script>
</body>
</html>
