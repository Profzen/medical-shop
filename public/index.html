<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>MedicalShop ‚Äî Fournitures m√©dicales</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/public/favicon.ico">
  <style>
    /* =========================
       MedicalShop - Index page (responsive + modales verticales)
       ========================= */
    :root{
      --bg: #f4f9ff;
      --nav-bg: #0b355f;
      --hero-bg: linear-gradient(180deg,#e6f2ff,#f8fbff);
      --panel-border: rgba(10,30,60,0.04);
      --accent-blue: #1f6feb;
      --accent-green: #1fb67a;
      --accent-green-2: #22c55e;
      --muted: #6b7b8f;
      --card-bg: #ffffff;
      --glass: rgba(31,111,235,0.06);
      --radius:12px;
      --shadow: 0 10px 30px rgba(9,30,66,0.06);
      --text-dark: #04273f;
      --footer-bg: #e8f5ff;
    }
    *{box-sizing:border-box}
    html,body{height:100%;overflow-x:hidden}
    body{ margin:0; font-family:Inter,system-ui,Roboto,Arial; background:var(--bg); color:var(--text-dark); -webkit-font-smoothing:antialiased; }
    .container{ max-width:1200px; margin:0 auto; padding:18px; }

    /* NAVBAR */
    header.header{ background:var(--nav-bg); color:white; padding:10px 0; position:sticky; top:0; z-index:80; box-shadow:0 6px 18px rgba(2,6,23,0.08); }
    .header-inner{ display:flex; gap:12px; align-items:center; max-width:1200px; margin:0 auto; padding:6px 18px; position:relative; }
    .logo { display:flex; gap:10px; align-items:center; font-weight:800; color:white; min-width:0 }
    .mark{ width:46px; height:46px; border-radius:10px; display:grid; place-items:center; background:linear-gradient(135deg,var(--accent-blue),var(--accent-green)); color:white; font-weight:900; flex-shrink:0 }
    nav.nav{ display:flex; gap:12px; margin-left:18px; align-items:center; }
    nav.nav a{ color:rgba(255,255,255,0.95); text-decoration:none; padding:8px 10px; border-radius:8px; font-weight:600; white-space:nowrap; }
    nav.nav a:hover{ background:rgba(255,255,255,0.04) }

    /* burger button (mobile) */
    .burger { display:none; background:transparent; border:0; color:white; font-size:22px; width:44px; height:44px; border-radius:8px; align-items:center; justify-content:center; cursor:pointer; }
    .burger-lines { display:inline-block; width:20px; height:2px; background:white; position:relative; }
    .burger-lines::before, .burger-lines::after { content:""; position:absolute; left:0; right:0; height:2px; background:white; }
    .burger-lines::before { top:-6px }
    .burger-lines::after { bottom:-6px }

    .search-box{ margin-left:auto; display:flex; gap:8px; align-items:center; min-width:0; position:relative; }
    .search-box input{ padding:10px 12px; border-radius:10px; border:0; width:220px; background:rgba(255,255,255,0.12); color:white; outline:none; min-width:0 }
    .search-box input::placeholder{ color:rgba(255,255,255,0.75) }

    .cart-btn{ position:relative; background:linear-gradient(135deg,var(--accent-blue),var(--accent-green)); color:white; padding:8px 10px; border-radius:999px; display:flex; gap:8px; align-items:center; border:0; cursor:pointer; font-weight:700; font-size:14px }
    .cart-badge{ position:absolute; top:-8px; right:-8px; background:#ff385c; color:white; font-weight:800; font-size:11px; padding:4px 7px; border-radius:999px; box-shadow:0 4px 8px rgba(0,0,0,0.12) }

    /* HERO */
    .hero-band{ background:var(--hero-bg); padding:36px 0; border-bottom:1px solid var(--panel-border); }
    .hero-inner{ display:flex; gap:18px; align-items:center; max-width:1200px; margin:0 auto; padding:0 18px; flex-wrap:wrap; }
    .kicker{ color:var(--accent-green); font-weight:800; margin-bottom:6px }
    .hero-title{ margin:0; font-size:30px; color:var(--text-dark) }
    .hero-sub{ margin-top:8px; color:var(--muted) }

    .btn{ background:linear-gradient(135deg,var(--accent-blue),#3ea1ff); color:white; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700 }
    .btn.ghost{ background:transparent; border:1px solid rgba(10,30,60,0.06); color:var(--text-dark) }

    .btn-buy-cta { background: linear-gradient(135deg, var(--accent-green), var(--accent-green-2)); color: #02281a; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800; box-shadow: 0 8px 20px rgba(34,197,94,0.12); }

    /* PRODUCTS GRID */
    .products-section{ padding:28px 0; max-width:1200px; margin:0 auto; /* keep container centering */ }
    .products-section.container{ padding-left:54px; padding-right:54px; } /* triple of 18px */
    .products-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:18px; }
    @media (max-width:1100px){ .products-grid{ grid-template-columns:repeat(3,1fr); } }
    @media (max-width:800px){ .products-grid{ grid-template-columns:repeat(2,1fr); } }
    @media (max-width:520px){ .products-grid{ grid-template-columns:1fr; } }

    .card{ background:var(--card-bg); border-radius:12px; padding:12px; box-shadow:var(--shadow); border:1px solid var(--panel-border); display:flex; flex-direction:column; gap:8px; min-height:220px; overflow:hidden }
    .thumb { width:100%; height:140px; border-radius:8px; overflow:hidden; background:#f3f7fb; display:flex; align-items:center; justify-content:center; }
    .thumb .imgwrap { width:100%; height:100%; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .thumb img { width: 100%;
  height: 140px;          /* ou la hauteur que tu utilises d√©j√† */
  object-fit: cover;      /* üîë change contain ‚Üí cover */
  object-position: center;/* centre l'image pour un crop √©quilibr√© */
  display: block;
  border-radius: 8px;     /* garde l'arrondi si tu l'avais */}

    .title-row{ display:flex; justify-content:space-between; align-items:center; gap:8px }
    .price{ font-weight:800; color:var(--text-dark) }
    .actions{ margin-top:auto; display:flex; gap:8px; flex-wrap:wrap }

    .card .btn-mini { padding:8px 10px; border-radius:8px; font-weight:700; font-size:13px }

    .load-more-wrap { display:flex; justify-content:center; margin-top:18px; grid-column:1/-1 }

    /* CART PANEL (floating) */
    .cart-panel{ position:fixed; right:18px; bottom:18px; width:360px; max-width:calc(100% - 36px); background:white; border-radius:12px; box-shadow:0 20px 50px rgba(2,8,23,0.12); padding:12px; border:1px solid var(--panel-border); display:none; z-index:300; }
    .cart-item{ display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid rgba(10,30,60,0.03) }
    .cart-thumb{ width:56px; height:56px; border-radius:8px; overflow:hidden; background:#f3f7fb; display:flex; align-items:center; justify-content:center }
    .cart-thumb img{ display:block; margin:auto; max-width:100%; max-height:100%; width:auto; height:auto; object-fit:contain; }
    .cart-footer{ display:flex; justify-content:space-between; align-items:center; margin-top:10px }

    /* MODALES - backdrop & modal sizing */
    .modal-backdrop{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,0.5); z-index:400; padding:20px; }
    .modal{ width:100%; max-width:760px; margin:0 auto; background:white; border-radius:12px; padding:22px; box-shadow:0 20px 60px rgba(2,8,23,0.2) }

    .modal .modal-stack{ display:flex; flex-direction:column; gap:14px; align-items:stretch; }
    .modal .modal-stack > * { width:100%; }
    .modal .modal-stack .form-grid{ display:flex; flex-direction:column; gap:12px; }
    .modal .modal-stack label.small{ display:block; margin-bottom:6px; color:var(--muted); font-size:13px }
    .modal .modal-stack input[type="text"], .modal .modal-stack input[type="tel"], .modal .modal-stack input[type="email"], .modal .modal-stack input[type="password"], .modal .modal-stack textarea, .modal .modal-stack select {
      width:100%; padding:12px; border-radius:8px; border:1px solid rgba(10,30,60,0.06); font-size:14px;
    }

    /* Add scroll to long modal content (signup) */
    .auth-modal .modal-inner { max-height:70vh; overflow:auto; padding-right:8px; }

    /* PRODUCT DETAIL PREVIEW adjustments */
    .product-modal .preview-large{ width:100%; height:320px; background:#f5f8fb; border-radius:10px; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .product-modal .preview-large .imgwrap{ width:100%; height:100%; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .product-modal .preview-large img{ width: 100%;
  height: 100%;
  object-fit: cover;       /* üîë */
  object-position: center; /* üîë */
  display: block;
  border-radius: 12px;     /* si tu as un style arrondi */ }

    /* Compact mode for buy modal (avoid huge height; adds internal scroll) */
    .buy-modal.compact { max-height:70vh; overflow:auto; padding-right:8px; }

    /* spinner */
    .spinner { display:inline-block; width:18px; height:18px; border:3px solid rgba(0,0,0,0.08); border-top-color: rgba(255,255,255,0.9); border-radius:50%; animation:spin 0.9s linear infinite; vertical-align:middle; }
    .spinner-dark { display:inline-block; width:18px; height:18px; border:3px solid rgba(0,0,0,0.08); border-top-color: rgba(31,111,235,1); border-radius:50%; animation:spin 0.9s linear infinite; vertical-align:middle; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* FOOTER */
    footer.footer{ margin-top:40px; padding:28px 0; background:linear-gradient(180deg,#dfeffb,var(--footer-bg)); border-top:1px solid var(--panel-border) }
    .footer-inner{ display:flex; gap:20px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap }

    .muted{ color:var(--muted) }
    .small{ font-size:13px; color:var(--muted) }

    .center{ text-align:center }
    .diag { color:#ffb86b; margin-top:8px; font-size:13px }

    /* MOBILE & RESPONSIVENESS TWEAKS */
    @media (max-width:980px){
      .container{ padding:14px }
      .hero-title { font-size:24px }
      .thumb { height:120px }
      .card{ min-height:200px; padding:10px }
      .search-box input { width:140px }
      .modal{ padding:18px; max-width:640px; }
      .products-section.container{ padding-left:24px; padding-right:24px; } /* adapt on smaller screens */
    }

    @media (max-width:780px){
      .search-box input { width:110px; padding:8px 10px; font-size:13px }
      nav.nav { display:none } /* will be toggled by burger */
      .header-inner { justify-content:space-between; padding:8px 12px }
      .hero-title { font-size:20px }
      .product-modal .preview-large{ height:220px }

      .burger { display:flex; margin-right:8px }
      .mark{ width:40px; height:40px; font-size:14px }
      .logo div { line-height:1; font-size:14px }
      .logo div div { font-size:12px }

      header.header.nav-open nav.nav{
        display:flex;
        position:absolute;
        left:12px;
        right:12px;
        top:66px;
        background:var(--nav-bg);
        padding:10px;
        border-radius:10px;
        flex-direction:column;
        gap:8px;
        box-shadow:0 10px 30px rgba(2,6,23,0.18);
      }

      /* ensure hero image goes to next line on small screens */
      .hero-inner { align-items:flex-start; }
      .hero-inner > div { flex: 1 1 100%; }
      .hero-inner > div:last-child { order: 2; margin-top:12px; }

      .products-section.container{ padding-left:18px; padding-right:18px; } /* mobile: use default small padding */
    }

    @media (max-width:520px){
      .container{ padding:12px }
      .products-grid{ gap:14px }
      .thumb { height:110px }
      .hero-inner{ padding:0 12px }
      .modal-backdrop{ padding:12px }
      .modal{ max-width:calc(100% - 24px); padding:14px }
      .cart-panel{ left:12px; right:12px; bottom:12px; width:auto; max-width:calc(100% - 24px) }
      .cart-thumb{ width:48px; height:48px }
      .cart-panel { border-radius:10px; padding:10px }
    }

    /* HISTORY MODAL small tweaks */
    .history-list { display:flex; flex-direction:column; gap:12px; max-height:60vh; overflow:auto; padding-top:8px; }
    .history-item { display:flex; gap:12px; align-items:flex-start; background:#fbfdff; padding:10px; border-radius:8px; border:1px solid rgba(10,30,60,0.03) }
    .history-thumb { width:92px; height:72px; border-radius:8px; overflow:hidden; background:#f3f7fb; display:flex; align-items:center; justify-content:center; }
    .history-thumb img{ display:block; margin:auto; max-width:100%; max-height:100%; object-fit:contain; }
    .history-meta { flex:1 }
    .history-meta h4 { margin:0 0 6px 0 }
    .history-items { font-size:13px; color:var(--muted) }

    @media (min-width:1300px){
      .container{ max-width:1300px }
      .products-grid{ gap:22px }
    }

    /* tiny dropdown for logged-in menu */
    .auth-menu { position:relative; display:inline-block; }
    .auth-dropdown { position:absolute; right:0; top:calc(100% + 6px); background:white; color:var(--text-dark); border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.12); padding:8px; display:none; min-width:180px; z-index:550; }
    .auth-dropdown a, .auth-dropdown button { display:block; width:100%; text-align:left; padding:8px;border-radius:6px; background:transparent; border:0; cursor:pointer; color:var(--text-dark) }
    .auth-dropdown a:hover, .auth-dropdown button:hover { background:rgba(0,0,0,0.04) }

    /* helper small toast */
    .toast {
      position:fixed; right:18px; bottom:24px; background:rgba(0,0,0,0.8); color:white; padding:10px 14px; border-radius:10px; z-index:999;
      box-shadow:0 8px 30px rgba(0,0,0,0.4);
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <header class="header" role="banner">
    <div class="header-inner">
      <div style="display:flex; align-items:center; gap:8px; min-width:0;">
        <!-- burger bouton (mobile) -->
        <button id="burgerBtn" class="burger" aria-label="Menu">
          <span class="burger-lines" aria-hidden="true"></span>
        </button>

        <div class="logo" style="min-width:0;">
          <a href="/" style="color:white; text-decoration:none; display:flex; gap:10px; align-items:center;">
            <div class="mark">M+</div>
            <div style="line-height:1; min-width:0;">
              <div style="font-weight:800; color:white; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:160px;">MedicalShop</div>
              <div style="font-size:11px; color:rgba(255,255,255,0.9); white-space:nowrap; overflow:hidden; text-overflow:ellipsis">m√©dical</div>
            </div>
          </a>
        </div>
      </div>

      <nav class="nav" aria-label="Navigation principale">
        <!-- replaced "Accueil" by auth slot -->
        <a id="navAuth" href="#" style="font-weight:700; color:rgba(255,255,255,0.95)">Se connecter</a>
        <a href="/products.html">Produits</a>
        <a href="/about.html">√Ä propos</a>
        <a href="/contact.html">Contact</a>
        <a id="navHistory" class="nav-history" href="#" style="margin-left:6px">Historique</a>
      </nav>

      <div class="search-box" role="search" aria-label="Recherche produits">
        <!-- fake/hidden field that absorbs autofill (very important) -->
        <input id="fake_email_absorb" type="email" name="fakeemail_autofill" autocomplete="email" style="position:absolute; left:-9999px; top:-9999px; opacity:0; width:1px; height:1px; pointer-events:none;" aria-hidden="true" />

        <!-- real search input: explicit autocomplete off, initially readonly to prevent autofill -->
        <input id="searchInput" type="search" inputmode="search" name="search_query_no_autofill" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Rechercher : gants, seringues..." aria-label="Recherche" readonly />
        <button id="cartBtn" class="cart-btn" title="Panier (0)">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:block"><path d="M3 3h2l.4 2M7 13h10l3-8H6.4" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span id="cartCount" style="font-weight:800">0</span>
        </button>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section class="hero-band" aria-hidden="false">
    <div class="hero-inner">
      <div style="flex:1; padding:6px 18px; min-width:0;">
        <div class="kicker">Fournitures m√©dicales</div>
        <h1 class="hero-title">Commande rapide pour √©tablissements de sant√©</h1>
        <p class="hero-sub">Catalogue professionnel, interface simple ‚Äî ajoute au panier ou commande directement.</p>
      </div>
      <div style="width:280px; text-align:center; padding-right:18px;">
        <!-- image made to cover & fade edges (reduced size per request) -->
        <div style="width:100%; height:140px; border-radius:8px; overflow:hidden; position:relative; display:flex; align-items:center; justify-content:center;">
          <img id="heroImage" src="med.jpeg" alt="illustration" style="width:100%; height:100%; object-fit:cover; display:block; opacity:0.92; filter:contrast(1.02)" />
          <!-- soft right-side gradient for "fondu" effect -->
          <div style="position:absolute; right:0; top:0; bottom:0; width:28%; background:linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.24)); pointer-events:none"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PRODUCTS -->
  <main class="products-section container" role="main" aria-labelledby="productsTitle">
    <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; gap:12px; flex-wrap:wrap;">
      <div style="min-width:0;">
        <h2 id="productsTitle" style="font-size:20px; font-weight:800; margin:0;">Produits en vedette</h2>
        <div class="small muted">Articles s√©lectionn√©s ‚Äî ajoute au panier ou ach√®te directement</div>
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <select id="categoryFilter" style="padding:10px 12px; border-radius:10px; border:1px solid rgba(10,30,60,0.06); background:white">
          <option value="">Toutes cat√©gories</option>
        </select>
        <button id="btnClearFilters" class="btn ghost">R√©initialiser</button>
      </div>
    </div>

    <div id="productsGrid" class="products-grid" aria-live="polite">
      <!-- Cards injected by JS -->
    </div>

    <div class="load-more-wrap">
      <button id="btnLoadMore" class="btn ghost">Voir plus</button>
    </div>
  </main>

  <!-- Cart panel (floating) -->
  <div id="cartPanel" class="cart-panel" aria-hidden="true" role="dialog" aria-label="Panier">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
      <strong>Panier</strong>
      <button id="btnCloseCart" class="btn ghost">Fermer</button>
    </div>
    <div id="cartList" style="max-height:340px; overflow:auto"></div>
    <div class="cart-footer">
      <div><strong>Total:</strong> <span id="cartTotal">0</span> XOF</div>
      <div>
        <button id="btnCheckout" class="btn-buy-cta" type="button">Commander</button>
      </div>
    </div>
  </div>

  <!-- Product detail modal (empilement vertical pour preview + d√©tails) -->
  <div id="productModal" class="modal-backdrop product-modal" aria-hidden="true" role="dialog" aria-label="D√©tails produit">
    <div class="modal">
      <div class="modal-stack">
        <div class="preview-large" id="productLargePreview"><div class="imgwrap"><img src="/public/nbbcl.png" alt="img"></div></div>

        <div>
          <h3 id="prodTitle" style="margin:0">Produit</h3>
          <div class="small muted" id="prodShort" style="margin-top:6px"></div>
          <div style="margin-top:8px; font-weight:800; font-size:18px" id="prodPrice">0 XOF</div>
          <!--<div class="small muted" id="prodStock">Stock: 0</div>-->

          <div class="actions-row" style="margin-top:12px;">
            <button id="prodAddToCart" class="btn" type="button">Ajouter</button>
            <button id="prodBuyNow" class="btn-buy-cta" type="button">Acheter</button>
            <button id="prodClose" class="btn ghost" type="button">Fermer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Buy modal (champs empil√©s verticalement ; r√©cap sous les champs) -->
  <div id="buyModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-label="Modal commande">
    <div class="modal buy-modal">
      <div class="modal-stack">
        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
          <h3 id="buyModalTitle" style="margin-top:0">Finaliser la commande</h3>
          <!-- toggle scroll/compact mode button to avoid huge modal -->
          <div>
            <button id="buyScrollBtn" class="btn ghost" type="button" title="Activer le d√©filement si la modal est longue">Activer d√©filement</button>
          </div>
        </div>

        <form id="buyForm" style="width:100%;">
          <div class="form-grid">
            <div>
              <label class="small">Nom complet</label>
              <input id="buyerName" required type="text" placeholder="Nom et pr√©nom">
            </div>
            <div>
              <label class="small">T√©l√©phone</label>
              <input id="buyerPhone" required type="tel" placeholder="+228 90 00 00 00">
            </div>
            <div>
              <label class="small">Adresse de livraison</label>
              <input id="buyerAddress" required type="text" placeholder="Adresse compl√®te">
            </div>

            <div id="qtyControls" style="display:flex; gap:8px; align-items:center;">
              <!-- quantity controls will be injected when single product -->
            </div>

            <div class="actions-row" style="margin-top:6px;">
              <button id="submitOrder" class="btn-buy-cta" type="submit">
                <span id="submitLabel">Valider la commande</span>
                <span id="submitSpinner" style="display:none; margin-left:8px"><span class="spinner" /></span>
              </button>
              <button id="cancelBuy" class="btn ghost" type="button">Annuler</button>
            </div>

            <div id="buyMsg" class="small muted" style="margin-top:8px"></div>
          </div>
        </form>

        <!-- R√©capitulatif plac√© sous les champs pour plus d'espace d'entr√©e -->
        <div style="width:100%;">
          <div class="small muted">R√©capitulatif</div>
          <div id="buySummary" style="margin-top:10px; background:#fbfdff; padding:12px; border-radius:8px; border:1px solid rgba(10,30,60,0.03)"></div>
        </div>
      </div>
    </div>
  </div>
  <!-- History modal (reads localStorage ms_orders_history_v1) -->
  <div id="historyModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-label="Historique commandes" style="display:none;">
    <div class="modal" style="max-width:900px;">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h3 style="margin:0">Historique des commandes</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="historyClose" class="btn ghost">Fermer</button>
        </div>
      </div>
      <div style="margin-top:12px; color:var(--muted);">Historique local (stock√© en localStorage)</div>
      <div id="historyList" class="history-list" style="margin-top:12px;">
        <!-- items injected by JS -->
      </div>
      <div id="historyEmpty" class="placeholder" style="display:none; margin-top:10px">Aucune commande enregistr√©e localement</div>
    </div>
  </div>

  <!-- AUTH Modal (Connexion / Cr√©er compte) -->
  <div id="authModal" class="modal-backdrop auth-modal" aria-hidden="true" role="dialog" aria-label="Authentification">
    <div class="modal" style="max-width:720px;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <h3 id="authTitle" style="margin:0">Connexion</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="authClose" class="btn ghost">Fermer</button>
        </div>
      </div>

      <div class="modal-inner" style="margin-top:12px">
        <div style="display:flex; gap:12px; margin-bottom:12px; align-items:center;">
          <button id="tabLogin" class="btn" style="padding:8px 12px">Connexion</button>
          <button id="tabRegister" class="btn ghost" style="padding:8px 12px">Cr√©er un compte</button>
        </div>

        <!-- LOGIN -->
        <div id="loginPane">
          <div class="modal-stack">
            <div class="form-grid">
              <div>
                <label class="small">Email ou t√©l√©phone</label>
                <input id="loginEmail" type="text" placeholder="email@example.com / +228..." />
              </div>
              <div>
                <label class="small">Mot de passe</label>
                <input id="loginPassword" type="password" placeholder="Mot de passe" />
              </div>
              <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                <button id="btnLoginSubmit" class="btn">Se connecter <span id="loginSpinner" style="display:none; margin-left:8px"><span class="spinner-dark"></span></span></button>
                <div class="small muted">Mot de passe oubli√© ?</div>
              </div>
              <div id="loginMsg" class="small muted"></div>
            </div>
          </div>
        </div>

        <!-- REGISTER -->
        <div id="registerPane" style="display:none">
          <div class="modal-stack">
            <form id="registerForm">
              <div style="display:flex; flex-direction:column; gap:10px;">
                <div>
                  <label class="small">Email</label>
                  <input id="regEmail" type="email" required placeholder="email@example.com" />
                </div>
                <div>
                  <label class="small">T√©l√©phone</label>
                  <input id="regPhone" type="tel" required placeholder="+228 90 00 00 00" />
                </div>
                <div>
                  <label class="small">Nom complet</label>
                  <input id="regFullName" type="text" required placeholder="Pr√©nom Nom" />
                </div>
                <div>
                  <label class="small">Nom de la soci√©t√©</label>
                  <input id="regCompany" type="text" required placeholder="Nom soci√©t√©" />
                </div>
                <div>
                  <label class="small">Adresse</label>
                  <input id="regAddress" type="text" required placeholder="Adresse compl√®te" />
                </div>
                <div style="display:flex; gap:8px;">
                  <div style="flex:1">
                    <label class="small">Mot de passe</label>
                    <input id="regPassword" type="password" required placeholder="Mot de passe" />
                  </div>
                  <div style="flex:1">
                    <label class="small">Confirmer mot de passe</label>
                    <input id="regPasswordConfirm" type="password" required placeholder="Confirmer" />
                  </div>
                </div>

                <div style="display:flex; gap:8px; align-items:center">
                  <input id="regAccept" type="checkbox" required />
                  <label for="regAccept" class="small">J'accepte les conditions d'utilisation</label>
                </div>

                <div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
                  <button id="btnRegisterSubmit" class="btn">Cr√©er un compte <span id="regSpinner" style="display:none; margin-left:8px"><span class="spinner-dark"></span></span></button>
                  <div class="small muted">Toutes les informations sont requises</div>
                </div>
                <div id="regMsg" class="small muted"></div>
              </div>
            </form>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer" role="contentinfo">
    <div class="container footer-inner">
      <div>
        <div style="font-weight:800; color:var(--text-dark)">MedicalShop</div>
        <div class="small muted">Approvisionnement m√©dical ‚Äî Togo & sous-r√©gion</div>
      </div>
      <div class="small muted">support@medicalshop.tg<br/>+228 90 00 00 00</div>
    </div>
  </footer>

  <!-- SUPABASE + APP LOGIC -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ===== CONFIG - remplace si besoin =====
    const SUPABASE_URL = "https://vrzmowqzegmaymewmbij.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyem1vd3F6ZWdtYXltZXdtYmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDMwNzksImV4cCI6MjA3MDg3OTA3OX0.TmkdqXhkVgbfhAWVj-qLC9bDTL0-_YoGz-SgS81sNG0";
    const EDGE_PROCESS_ORDER_URL = ""; // optional
    // =======================================

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // DOM refs used across code
    const productsGrid = document.getElementById('productsGrid');
    const searchInput = document.getElementById('searchInput');
    const fakeEmailAbsorb = document.getElementById('fake_email_absorb');
    const categoryFilter = document.getElementById('categoryFilter');
    const btnClearFilters = document.getElementById('btnClearFilters');
    const btnLoadMore = document.getElementById('btnLoadMore');
    const cartBtn = document.getElementById('cartBtn');
    const cartCountEl = document.getElementById('cartCount');
    const cartPanel = document.getElementById('cartPanel');
    const btnCloseCart = document.getElementById('btnCloseCart');
    const cartList = document.getElementById('cartList');
    const cartTotalEl = document.getElementById('cartTotal');
    const btnCheckout = document.getElementById('btnCheckout');
    const productModal = document.getElementById('productModal');
    const prodTitle = document.getElementById('prodTitle');
    const prodShort = document.getElementById('prodShort');
    const prodPrice = document.getElementById('prodPrice');
    const prodStock = document.getElementById('prodStock');
    const productLargePreview = document.getElementById('productLargePreview');
    const prodAddToCart = document.getElementById('prodAddToCart');
    const prodBuyNow = document.getElementById('prodBuyNow');
    const prodClose = document.getElementById('prodClose');

    const buyModal = document.getElementById('buyModal');
    const buyModalInner = buyModal.querySelector('.modal');
    const buyForm = document.getElementById('buyForm');
    const buyerName = document.getElementById('buyerName');
    const buyerPhone = document.getElementById('buyerPhone');
    const buyerAddress = document.getElementById('buyerAddress');
    const buySummary = document.getElementById('buySummary');
    const buyMsg = document.getElementById('buyMsg');
    const cancelBuy = document.getElementById('cancelBuy');
    const qtyControls = document.getElementById('qtyControls');
    const submitOrderBtn = document.getElementById('submitOrder');
    const submitLabel = document.getElementById('submitLabel');
    const submitSpinner = document.getElementById('submitSpinner');
    const buyScrollBtn = document.getElementById('buyScrollBtn');

    const historyModal = document.getElementById('historyModal');
    const historyList = document.getElementById('historyList');
    const historyEmpty = document.getElementById('historyEmpty');
    const navHistory = document.getElementById('navHistory');
    const historyClose = document.getElementById('historyClose');

    // AUTH modal refs
    const authModal = document.getElementById('authModal');
    const authClose = document.getElementById('authClose');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginPane = document.getElementById('loginPane');
    const registerPane = document.getElementById('registerPane');
    const navAuth = document.getElementById('navAuth');
    const authTitle = document.getElementById('authTitle');

    // login fields
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const btnLoginSubmit = document.getElementById('btnLoginSubmit');
    const loginSpinner = document.getElementById('loginSpinner');
    const loginMsg = document.getElementById('loginMsg');

    // register fields
    const registerForm = document.getElementById('registerForm');
    const regEmail = document.getElementById('regEmail');
    const regPhone = document.getElementById('regPhone');
    const regFullName = document.getElementById('regFullName');
    const regCompany = document.getElementById('regCompany');
    const regAddress = document.getElementById('regAddress');
    const regPassword = document.getElementById('regPassword');
    const regPasswordConfirm = document.getElementById('regPasswordConfirm');
    const regAccept = document.getElementById('regAccept');
    const btnRegisterSubmit = document.getElementById('btnRegisterSubmit');
    const regSpinner = document.getElementById('regSpinner');
    const regMsg = document.getElementById('regMsg');

    // small helpers
    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function flashMessage(msg, t=2200){ const el=document.createElement('div'); el.textContent=msg; el.className='toast'; document.body.appendChild(el); setTimeout(()=> el.style.opacity='0.01', t-200); setTimeout(()=> el.remove(), t); }
    function currencyFormat(n){ return Number(n||0).toLocaleString('fr-FR'); }

    // CART storage
    const CART_KEY = 'ms_cart_v1';
    function loadCart(){ try{ const raw = localStorage.getItem(CART_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
    function saveCart(cart){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); updateCartBadge(); }
    function updateCartBadge(){ const cart=loadCart(); const count = cart.reduce((s,i)=> s + (i.qty||0), 0); cartCountEl.textContent = String(count); cartBtn.title = `Panier (${count})`; }

    // STORAGE helper: convert storage path to public url (safe)
    async function computePublicUrlFromPath(path){
      if (!path) return null;
      try {
        const { data, error } = await supabase.storage.from('products').getPublicUrl(path);
        if (error) { console.warn('getPublicUrl error', error); return null; }
        return data?.publicUrl ?? null;
      } catch (e) { console.warn('computePublicUrlFromPath err', e); return null; }
    }

    // ... (loadProducts/renderProducts, unchanged from earlier version) ...
    // For brevity here I keep the same product rendering / loading functions you already use.
    // (They are unchanged except I ensured buttons created in card markup include type="button".)
    // ----- Render functions start -----
    let PRODUCTS = [];
    let CATEGORIES = [];
    let productsOffset = 0;
    const productsLimit = 20;

    function renderCategories(options){
      categoryFilter.innerHTML = '<option value="">Toutes cat√©gories</option>';
      for (const c of options) {
        const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; categoryFilter.appendChild(o);
      }
    }

    function renderProducts(list, append = false){
      if (!append) productsGrid.innerHTML = '';
      if (!list || list.length === 0) {
        if (!append) productsGrid.innerHTML = `<div style="grid-column:1/-1" class="small muted">Aucun produit</div>`;
        return;
      }
      for (const p of list) {
        const card = document.createElement('div'); card.className = 'card';
        const imgUrl = p.image_url || p.image_path || '/public/nbbcl.png';
        card.innerHTML = `
          <div class="thumb"><div class="imgwrap"><img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(p.title)}" loading="lazy" data-id="${escapeHtml(p.id)}" data-path="${escapeHtml(p.image_path || '')}"></div></div>
          <div class="title-row"><div style="min-width:0"><div style="font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(p.title)}</div><div class="small muted" style="margin-top:6px">${escapeHtml(p.short_description || '')}</div></div><div class="price">${currencyFormat(p.price)} XOF</div></div>
          <div class="small muted">Stock: <span class="stock-value">${p.stock ?? 0}</span></div>
          <div class="actions">
            <button class="btn btn-mini btn-add" type="button">Ajouter</button>
            <button class="btn btn-mini btn-view" type="button">Voir</button>
            <button class="btn-buy-cta btn-buy" type="button">Acheter</button>
          </div>
        `;
        card.querySelector('.btn-add').addEventListener('click', ()=> addToCart(p, 1));
        card.querySelector('.btn-view').addEventListener('click', ()=> openProductModal(p));
        card.querySelector('.btn-buy').addEventListener('click', ()=> openBuyModalWithProduct(p));
        productsGrid.appendChild(card);

        if (!p.image_url && p.image_path) {
          (async () => {
            try {
              const url = await computePublicUrlFromPath(p.image_path);
              if (url) {
                const img = card.querySelector(`img[data-id="${escapeHtml(p.id)}"]`);
                if (img) img.src = url;
                tryUpdateImageUrlInDb(p.id, url, p.image_path);
                const cart = loadCart();
                let mutated = false;
                for (let it of cart) {
                  if (it.productId === p.id && (!it.image_url || it.image_url === p.image_path)) {
                    it.image_url = url;
                    mutated = true;
                  }
                }
                if (mutated) saveCart(cart);
              }
            } catch (e) { console.warn('resolve img err', e); }
          })();
        }
      }
    }

    function wireLoadMoreAsRedirect(){
      btnLoadMore.textContent = 'Voir plus';
      btnLoadMore.onclick = () => { window.location.href = '/products.html'; };
    }

    async function loadCategories(){
      try {
        const { data, error } = await supabase.from('categories').select('id,name').eq('is_active', true).order('name',{ ascending:true });
        if (error) { console.warn('categories err', error); return; }
        CATEGORIES = data || [];
        renderCategories(CATEGORIES);
      } catch (err) { console.error(err); }
    }

    async function loadProducts(reset = false){
      if (reset) {
        productsOffset = 0;
        PRODUCTS = [];
      }
      productsGrid.innerHTML = '<div style="grid-column:1/-1">Chargement‚Ä¶</div>';
      try {
        const from = productsOffset;
        const to = productsOffset + productsLimit - 1;
        let qb = supabase.from('products').select('*').order('created_at',{ ascending:false }).range(from,to);

        const q = (searchInput.value || '').trim();
        if (q) qb = qb.ilike('title', `%${q}%`);
        if (categoryFilter.value) qb = qb.eq('category_id', categoryFilter.value);

        const { data, error } = await qb;
        if (error) {
          console.warn('products fetch err', error);
          productsGrid.innerHTML = `<div style="grid-column:1/-1" class="small muted">Erreur chargement</div>`;
          return;
        }

        const fetched = data || [];
        PRODUCTS = PRODUCTS.concat(fetched);
        renderProducts(fetched, /*append=*/ productsOffset > 0);

        wireLoadMoreAsRedirect();

        productsOffset += fetched.length;
      } catch (err) {
        console.error('loadProducts err', err);
        productsGrid.innerHTML = `<div style="grid-column:1/-1" class="small muted">Erreur</div>`;
      }
    }

    // CART functions
    function addToCart(p, qty = 1){
      const cart = loadCart();
      const idx = cart.findIndex(i => i.productId === p.id);
      const imgSource = p.image_url || p.image_path || '/public/nbbcl.png';
      if (idx >= 0) cart[idx].qty += qty;
      else cart.push({ productId: p.id, qty, title: p.title, price: Number(p.price||0), image_url: imgSource });
      saveCart(cart);
      flashMessage(`Ajout√© au panier : ${p.title}`);
    }

    function renderCartPanel(){
      const cart = loadCart();
      cartList.innerHTML = '';
      if (cart.length === 0) {
        cartList.innerHTML = '<div class="small muted">Panier vide</div>';
        cartTotalEl.textContent = '0';
        return;
      }
      let total = 0;
      for (const item of cart) {
        total += (item.price || 0) * (item.qty || 1);
        const row = document.createElement('div'); row.className = 'cart-item';
        row.innerHTML = `<div class="cart-thumb"><img src="${escapeHtml(item.image_url || '/public/nbbcl.png')}" alt=""></div>
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(item.title)}</div>
            <div class="small muted">${currencyFormat(item.price)} XOF √ó ${item.qty}</div>
          </div>
          <div style="display:flex; flex-direction:column; gap:6px;">
            <button class="btn ghost small dec" type="button">-</button>
            <button class="btn ghost small inc" type="button">+</button>
            <button class="btn ghost small rem" type="button">‚úï</button>
          </div>`;
        row.querySelector('.dec').addEventListener('click', ()=> changeCartQty(item.productId, -1));
        row.querySelector('.inc').addEventListener('click', ()=> changeCartQty(item.productId, +1));
        row.querySelector('.rem').addEventListener('click', ()=> removeCartItem(item.productId));
        cartList.appendChild(row);
      }
      cartTotalEl.textContent = currencyFormat(total);
    }

    function changeCartQty(productId, delta){
      const cart = loadCart();
      const idx = cart.findIndex(i => i.productId === productId);
      if (idx < 0) return;
      cart[idx].qty += delta;
      if (cart[idx].qty <= 0) cart.splice(idx,1);
      saveCart(cart);
      renderCartPanel();
    }

    function removeCartItem(productId){
      const cart = loadCart().filter(i => i.productId !== productId);
      saveCart(cart);
      renderCartPanel();
    }

    // product modal
    async function openProductModal(p){
      prodTitle.textContent = p.title || 'Produit';
      prodShort.textContent = p.short_description || p.description || '';
      prodPrice.textContent = `${currencyFormat(p.price)} XOF`;
      prodStock.textContent = `Stock: ${p.stock ?? 0}`;
      const initialSrc = p.image_url || p.image_path || '/public/nbbcl.png';
      productLargePreview.innerHTML = `<div class="imgwrap"><img src="${escapeHtml(initialSrc)}" alt="${escapeHtml(p.title)}" data-path="${escapeHtml(p.image_path||'')}" data-id="${escapeHtml(p.id)}"></div>`;

      if (!p.image_url && p.image_path) {
        (async () => {
          const url = await computePublicUrlFromPath(p.image_path).catch(()=>null);
          if (url) {
            const img = productLargePreview.querySelector('img');
            if (img) img.src = url;
            tryUpdateImageUrlInDb(p.id, url, p.image_path);
          }
        })();
      }

      prodAddToCart.onclick = () => { addToCart(p, 1); closeProductModal(); };
      prodBuyNow.onclick = () => { openBuyModalWithProduct(p); closeProductModal(); };
      prodClose.onclick = closeProductModal;
      productModal.style.display = 'grid';
      productModal.setAttribute('aria-hidden','false');
    }
    function closeProductModal(){
      productModal.style.display = 'none';
      productModal.setAttribute('aria-hidden','true');
    }

    // --- PARTIE ACHAT & ENVOI EMAIL via /api/send-email (m√™me logique que products.html) ---

    // buy modal functions
    let BUY_CONTEXT = { items: [], fromCart: false };
    function openBuyModalWithProduct(product){
      BUY_CONTEXT = { items: [{ productId: product.id, qty: 1, title: product.title, price: Number(product.price||0), image_url: product.image_url || product.image_path || '/public/nbbcl.png' }], fromCart: false };
      populateBuySummary();
      prepareQtyControls();
      showBuyModal(true);
    }
    function openBuyModalFromCart(){
      const cart = loadCart();
      if (!cart || cart.length === 0) { flashMessage('Le panier est vide'); return; }
      BUY_CONTEXT = { items: cart.map(i=>({ ...i })), fromCart: true };
      populateBuySummary();
      clearQtyControls(); // for cart, no single product qty control
      showBuyModal(true);
    }
    function showBuyModal(show){
      buyModal.style.display = show ? 'grid' : 'none';
      buyModal.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (show) window.scrollTo({ top:0, behavior:'smooth' });
    }

    function populateBuySummary(){
      const items = BUY_CONTEXT.items || [];
      const lines = items.map(it => `<div style="display:flex;justify-content:space-between;margin-bottom:6px"><div>${escapeHtml(it.title)} √ó${it.qty}</div><div>${currencyFormat((it.price||0)*it.qty)} XOF</div></div>`).join('');
      const total = items.reduce((s,i)=> s + (i.price||0)*(i.qty||0), 0);
      buySummary.innerHTML = `${lines}${lines ? '<hr style="border:none;border-top:1px solid rgba(10,30,60,0.06);margin:8px 0">' : ''}<div style="display:flex;justify-content:space-between"><strong>Total</strong><strong>${currencyFormat(total)} XOF</strong></div>`;
    }

    function prepareQtyControls(){
      const items = BUY_CONTEXT.items || [];
      if (!items || items.length !== 1) { clearQtyControls(); return; }
      const it = items[0];
      qtyControls.innerHTML = '';
      const dec = document.createElement('button'); dec.className = 'btn ghost'; dec.textContent = '-'; dec.type = 'button';
      const inp = document.createElement('div'); inp.style.minWidth = '44px'; inp.style.textAlign = 'center'; inp.style.fontWeight = '700'; inp.textContent = String(it.qty);
      const inc = document.createElement('button'); inc.className = 'btn'; inc.textContent = '+'; inc.type = 'button';

      // Important: use non-submit buttons and preventDefault just in case
      dec.addEventListener('click', (ev)=> {
        ev.preventDefault();
        if (it.qty <= 1) return;
        it.qty -= 1; inp.textContent = String(it.qty); populateBuySummary();
      });
      inc.addEventListener('click', (ev)=> {
        ev.preventDefault();
        it.qty += 1; inp.textContent = String(it.qty); populateBuySummary();
      });
      qtyControls.appendChild(dec);
      qtyControls.appendChild(inp);
      qtyControls.appendChild(inc);
    }
    function clearQtyControls(){ qtyControls.innerHTML = ''; }

    // order number gen
    function genOrderNumber(){
      const now = new Date();
      const dd = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}`;
      const rand = Math.random().toString(36).substring(2,7).toUpperCase();
      return `MS-${dd}-${rand}`;
    }

    // NEW: sendOrderEmail now calls your server endpoint /api/send-email (no SMTP creds in frontend)
    async function sendOrderEmailToServer(orderMeta, items){
      try {
        await fetch('/api/send-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderMeta, items })
        });
      } catch (err) {
        console.warn('sendOrderEmailToServer err', err);
      }
    }

    // Submit order with stock decrement
    let processingOrder = false;
    async function submitOrder(evt){
      evt && evt.preventDefault();
      if (processingOrder) return;
      buyMsg.textContent = '';
      const name = buyerName.value.trim();
      const phone = buyerPhone.value.trim();
      const address = buyerAddress.value.trim();
      if (!name || !phone || !address) { buyMsg.textContent = 'Nom, t√©l√©phone et adresse requis'; return; }
      const items = (BUY_CONTEXT.items || []).map(i => ({ ...i }));
      if (!items || items.length === 0) { buyMsg.textContent = 'Aucun article √† commander'; return; }

      processingOrder = true;
      submitOrderBtn.disabled = true;
      submitSpinner.style.display = 'inline-block';

      try {
        const total = items.reduce((s,i)=> s + (i.price||0)*(i.qty||0), 0);
        const order_number = genOrderNumber();
        const orderPayload = {
          order_number,
          order_name: name,
          user_id: null,
          status: 'pending',
          payment_status: 'unpaid',
          total_amount: total,
          total: total,
          currency: 'XOF',
          shipping_address: address,
          phone: phone
        };

        const { data: orderData, error: orderErr } = await supabase.from('orders').insert([orderPayload]).select().single();
        if (orderErr || !orderData) {
          console.error('order insert err', orderErr);
          buyMsg.textContent = `Erreur cr√©ation commande: ${orderErr?.message || 'voir console'}`;
          processingOrder = false;
          submitOrderBtn.disabled = false;
          submitSpinner.style.display = 'none';
          return;
        }
        const orderId = orderData.id;

        const itemsPayload = items.map(it => ({
          order_id: orderId,
          product_id: it.productId,
          quantity: it.qty,
          price_at_order: it.price,
          status: 'pending',
          phone: phone,
          order_number: order_number,
          order_name: name,
          shipping_address: address
        }));
        const { data: itemsRes, error: itemsErr } = await supabase.from('order_items').insert(itemsPayload).select();
        if (itemsErr) { console.error('order_items insert err', itemsErr); }

        // decrement stock for each product (await each update and log errors)
        try {
          await Promise.all(items.map(async it => {
            try {
              const { data: prodData, error: pErr } = await supabase.from('products').select('id,stock').eq('id', it.productId).single();
              if (pErr || !prodData) { console.warn('product fetch failed', pErr); return; }
              const newStock = (Number(prodData.stock || 0) - Number(it.qty || 0));
              const safeStock = newStock < 0 ? 0 : newStock;
              const { error: upErr } = await supabase.from('products').update({ stock: safeStock }).eq('id', it.productId);
              if (upErr) console.warn('stock update failed (client):', upErr);
            } catch (e) { console.warn('stock decrement err', e); }
          }));
        } catch (e) { console.warn('stock Promise.all err', e); }

        // Edge option - unchanged
        let edgeOk = false;
        if (EDGE_PROCESS_ORDER_URL) {
          try {
            const res = await fetch(EDGE_PROCESS_ORDER_URL, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ orderId })
            });
            if (res.ok) {
              edgeOk = true;
            } else {
              console.warn('Edge returned non-ok', await res.text());
            }
          } catch (edgeErr) { console.warn('Edge call failed', edgeErr); }
        }

        try {
          const histKey = 'ms_orders_history_v1';
          const raw = localStorage.getItem(histKey);
          const hist = raw ? JSON.parse(raw) : [];
          hist.push({
            id: orderId,
            order_number,
            order_name: name,
            phone,
            shipping_address: address,
            total,
            currency: 'XOF',
            status: 'pending',
            created_at: new Date().toISOString(),
            items: items.map(it => ({ productId: it.productId, title: it.title, qty: it.qty, price: it.price, image_url: it.image_url || '/public/nbbcl.png' }))
          });
          localStorage.setItem(histKey, JSON.stringify(hist));
        } catch (e) { /* ignore */ }

        // send email via server endpoint (same approach as products.html)
        try {
          await sendOrderEmailToServer({ id:orderId, order_number, order_name:name, phone, shipping_address: address, total, currency:'XOF'}, items);
        } catch(e){ console.warn(e); }

        if (BUY_CONTEXT.fromCart) localStorage.removeItem(CART_KEY);
        updateCartBadge();
        renderCartPanel();
        await loadProducts(true); // refresh product list to show updated stocks
        showBuyModal(false);
        flashMessage('Commande cr√©√©e ‚Äî num√©ro: ' + order_number);
      } catch (err) {
        console.error('submitOrder err', err);
        buyMsg.textContent = 'Erreur envoi commande (voir console)';
      } finally {
        processingOrder = false;
        submitOrderBtn.disabled = false;
        submitSpinner.style.display = 'none';
      }
    }

    // HISTORY modal functions
    function loadLocalHistory(){
      try {
        const raw = localStorage.getItem('ms_orders_history_v1');
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr.slice().reverse();
      } catch (e) { console.warn('loadLocalHistory err', e); return []; }
    }

    function renderHistory(){
      const data = loadLocalHistory();
      historyList.innerHTML = '';
      if (!data || data.length === 0) {
        historyEmpty.style.display = '';
        return;
      } else {
        historyEmpty.style.display = 'none';
      }
      for (const o of data) {
        const meta = document.createElement('div'); meta.className = 'history-item';
        const firstImg = (o.items && o.items[0] && (o.items[0].image_url || o.items[0].image)) ? (o.items[0].image_url || o.items[0].image) : '/public/nbbcl.png';
        const itemsSummary = (o.items || []).map(it => `${it.title || ('id:'+String(it.productId).slice(0,6))} √ó${it.qty || 1}`).join(' / ');
        meta.innerHTML = `
          <div class="history-thumb"><img src="${escapeHtml(firstImg)}" alt="thumb"></div>
          <div class="history-meta">
            <h4>${escapeHtml(o.order_number || String(o.id || '').slice(0,12))} ‚Äî ${escapeHtml(o.order_name || 'Client anonyme')}</h4>
            <div class="small muted">${escapeHtml(new Date(o.created_at || o.createdAt || Date.now()).toLocaleString())} ‚Ä¢ ${escapeHtml(String(o.total || o.total_amount || 0))} ${escapeHtml(o.currency || 'XOF')}</div>
            <div class="history-items" style="margin-top:8px">${escapeHtml(itemsSummary)}</div>
          </div>
        `;
        historyList.appendChild(meta);
      }
    }

    function openHistoryModal(){
      renderHistory();
      historyModal.style.display = 'grid';
      historyModal.setAttribute('aria-hidden','false');
    }
    function closeHistoryModal(){
      historyModal.style.display = 'none';
      historyModal.setAttribute('aria-hidden','true');
    }

    historyClose.addEventListener('click', closeHistoryModal);
    navHistory.addEventListener('click', (e) => { e.preventDefault(); openHistoryModal(); });

    // ---------------------------
    // AUTH UI and logic
    // ---------------------------

    // helper: compute SHA-256 hex for password hashing (client-side)
    async function hashSha256Hex(msg){
      const enc = new TextEncoder();
      const data = enc.encode(msg);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2,'0')).join('');
      return hashHex;
    }

    // show / hide auth modal, and switch panes
    function showAuthModal(show, pane='login'){
      authModal.style.display = show ? 'grid' : 'none';
      authModal.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (show) {
        if (pane === 'register') { switchToRegister(); } else { switchToLogin(); }
      }
    }
    function switchToLogin(){
      loginPane.style.display = '';
      registerPane.style.display = 'none';
      authTitle.textContent = 'Connexion';
      tabLogin.classList.remove('btn-ghost'); tabLogin.classList.add('btn');
      tabRegister.classList.remove('btn'); tabRegister.classList.add('btn','ghost');
    }
    function switchToRegister(){
      loginPane.style.display = 'none';
      registerPane.style.display = '';
      authTitle.textContent = 'Cr√©er un compte';
      tabRegister.classList.remove('btn-ghost'); tabRegister.classList.add('btn');
      tabLogin.classList.remove('btn'); tabLogin.classList.add('btn','ghost');
    }

    tabLogin.addEventListener('click', ()=> switchToLogin());
    tabRegister.addEventListener('click', ()=> switchToRegister());
    authClose.addEventListener('click', ()=> showAuthModal(false));

    // open auth modal behaviour: navAuth click
    let loggedUser = null;
    function showLoggedState(user){
      // user: { id, email, ... } or null
      loggedUser = user;
      // remove any existing auth-menu wrapper to avoid duplicates
      const existingMenu = document.querySelector('.auth-menu');
      if (existingMenu) existingMenu.remove();

      if (!user) {
        navAuth.textContent = 'Se connecter';
        navAuth.href = '#';
        navAuth.onclick = (e) => { e.preventDefault(); showAuthModal(true,'login'); };
        return;
      }
      // show email text (but never place it into searchInput)
      navAuth.textContent = user.email || (user.id || 'Connect√©');
      navAuth.href = '#';
      navAuth.onclick = (e) => { e.preventDefault(); toggleAuthDropdown(); };
      ensureAuthDropdown(user);
    }

    function ensureAuthDropdown(user){
      // Append a small dropdown next to navAuth (if not created)
      let menuWrap = navAuth.parentElement.querySelector('.auth-menu');
      if (!menuWrap) {
        menuWrap = document.createElement('span'); menuWrap.className = 'auth-menu';
        // insert directly after navAuth
        navAuth.parentElement.insertBefore(menuWrap, navAuth.nextSibling);
      }
      // create dropdown content
      let drop = menuWrap.querySelector('.auth-dropdown');
      if (!drop) {
        drop = document.createElement('div'); drop.className='auth-dropdown';
        drop.innerHTML = `<div style="font-weight:700; padding:6px 8px">${escapeHtml(user.email || user.id)}</div>
          <div style="border-top:1px solid rgba(0,0,0,0.04); margin-top:6px"></div>
          <button id="btnSignOutSmall">Se d√©connecter</button>`;
        menuWrap.appendChild(drop);
        menuWrap.querySelector('#btnSignOutSmall').addEventListener('click', async ()=>{
          await supabase.auth.signOut();
          showLoggedState(null);
          flashMessage('D√©connect√©');
        });
      }
      drop.style.display = 'none';
    }

    function toggleAuthDropdown(){
      const menuWrap = navAuth.parentElement.querySelector('.auth-menu');
      if (!menuWrap) return;
      const drop = menuWrap.querySelector('.auth-dropdown');
      if (!drop) return;
      drop.style.display = drop.style.display === 'block' ? 'none' : 'block';
    }

    // Close auth dropdown on outside click
    document.addEventListener('click', (e) => {
      const menuWrap = document.querySelector('.auth-menu');
      if (!menuWrap) return;
      const drop = menuWrap.querySelector('.auth-dropdown');
      if (!drop) return;
      if (!menuWrap.contains(e.target) && e.target !== navAuth) drop.style.display = 'none';
    });

    // Login attempt
    btnLoginSubmit.addEventListener('click', async (e) => {
      e.preventDefault();
      loginMsg.textContent = '';
      const identifier = (loginEmail.value || '').trim();
      const password = (loginPassword.value || '').trim();
      if (!identifier || !password) { loginMsg.textContent = 'Email/phone + mot de passe requis'; return; }

      // show spinner
      btnLoginSubmit.disabled = true; loginSpinner.style.display = 'inline-block';

      try {
        const { data, error } = await supabase.auth.signInWithPassword({ email: identifier, password });
        if (error) {
          console.warn('login err', error);
          loginMsg.textContent = error.message || '√âchec connexion';
          return;
        }
        const user = data.user;
        showLoggedState({ id: user.id, email: user.email });
        showAuthModal(false);
        flashMessage('Connexion r√©ussie');
      } catch (err) {
        console.error('login unexpected err', err);
        loginMsg.textContent = 'Erreur connexion (voir console)';
      } finally {
        btnLoginSubmit.disabled = false; loginSpinner.style.display = 'none';
      }
    });

    // Register attempt
    btnRegisterSubmit.addEventListener('click', async (e) => {
      e.preventDefault();
      regMsg.textContent = '';

      const email = (regEmail.value || '').trim();
      const phone = (regPhone.value || '').trim();
      const full_name = (regFullName.value || '').trim();
      const company_name = (regCompany.value || '').trim();
      const address = (regAddress.value || '').trim();
      const pw = (regPassword.value || '').trim();
      const pwc = (regPasswordConfirm.value || '').trim();
      const accept = regAccept.checked;

      if (!email || !phone || !full_name || !company_name || !address || !pw || !pwc) { regMsg.textContent = 'Tous les champs sont requis'; return; }
      if (pw !== pwc) { regMsg.textContent = 'Les mots de passe ne correspondent pas'; return; }
      if (!accept) { regMsg.textContent = 'Vous devez accepter les conditions'; return; }

      // spinner
      btnRegisterSubmit.disabled = true; regSpinner.style.display = 'inline-block';

      try {
        // create auth user
        const { data, error } = await supabase.auth.signUp({ email, password: pw });
        if (error) {
          console.warn('auth.signUp err', error);
          regMsg.textContent = error.message || 'Erreur cr√©ation compte';
          return;
        }
        const user = data.user;
        if (!user || !user.id) {
          regMsg.textContent = 'Impossible de cr√©er le compte (id manquant)';
          return;
        }

        // compute client-side password hash (SHA-256 hex) to store in users.password_hash (if desired)
        let password_hash = null;
        try { password_hash = await hashSha256Hex(pw); } catch(e){ console.warn('hash err', e); password_hash = null; }

        // Check if confirmation required: if yes inform user to confirm email
        const needsConfirmation = Boolean(data?.user?.confirmation_sent_at && !data?.user?.confirmed_at);
        if (needsConfirmation) {
          regMsg.textContent = 'Un e-mail de confirmation a √©t√© envoy√©. Veuillez confirmer votre adresse e-mail avant de vous connecter.';
          showAuthModal(false);
          flashMessage('V√©rifiez votre e-mail pour confirmer votre compte');
          return;
        }

        // otherwise insert profile
        const now = new Date().toISOString();
        const profile = {
          id: user.id,
          email,
          phone,
          full_name,
          company_name,
          address,
          password_hash,
          created_at: now,
          updated_at: now
        };

        const { data: inserted, error: insertErr } = await supabase.from('users').insert([profile]).select().single();
        if (insertErr) {
          console.warn('users insert err', insertErr);
          regMsg.innerHTML = `Compte cr√©√© (auth) ‚Äî mais profil non cr√©√©: ${escapeHtml(insertErr.message || String(insertErr))} <span class="small muted" style="display:block">Code: ${escapeHtml(insertErr.code || '')}</span>`;
          showLoggedState({ id: user.id, email: user.email });
          showAuthModal(false);
          flashMessage('Compte cr√©√© (auth) ‚Äî profil non ins√©r√©');
          return;
        }

        showLoggedState({ id: user.id, email: user.email });
        showAuthModal(false);
        flashMessage('Inscription r√©ussie');
      } catch (err) {
        console.error('register unexpected err', err);
        regMsg.textContent = 'Erreur inscription (voir console)';
      } finally {
        btnRegisterSubmit.disabled = false; regSpinner.style.display = 'none';
      }
    });

    // If already logged in on load show state
    (async function checkAuthOnLoad(){
      try {
        const { data } = await supabase.auth.getUser();
        if (data?.user) {
          showLoggedState({ id: data.user.id, email: data.user.email });
        } else {
          showLoggedState(null);
        }
      } catch (e) {
        console.warn('auth.getUser err', e);
      }
    })();

    // other small UI interactions
    const burger = document.getElementById('burgerBtn');
    const header = document.querySelector('.header');
    if (burger && header) {
      burger.addEventListener('click', function(e){ e.stopPropagation(); header.classList.toggle('nav-open'); });
      document.addEventListener('click', function(ev){ if (!header.classList.contains('nav-open')) return; if (!header.contains(ev.target)) header.classList.remove('nav-open'); });
    }

    // wire various buttons/events
    searchInput.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { productsOffset = 0; loadProducts(true); } });
    categoryFilter.addEventListener('change', ()=> { productsOffset = 0; loadProducts(true); });
    btnClearFilters.addEventListener('click', ()=> { categoryFilter.value = ''; searchInput.value = ''; productsOffset = 0; loadProducts(true); });
    btnLoadMore.addEventListener('click', ()=> { window.location.href = '/products.html'; });

    cartBtn.addEventListener('click', ()=>{ 
      const visible = cartPanel.style.display === 'block';
      if (!visible) { renderCartPanel(); cartPanel.style.display = 'block'; }
      else cartPanel.style.display = 'none';
    });
    btnCloseCart.addEventListener('click', ()=> cartPanel.style.display = 'none');
    btnCheckout.addEventListener('click', ()=> openBuyModalFromCart());

    cancelBuy.addEventListener('click', ()=> { showBuyModal(false); });
    buyForm.addEventListener('submit', submitOrder);

    // --- Robust anti-autofill logic for the search input ---
    function ensureSearchInputNotAutofilled(){
      try {
        // Ensure hidden absorber exists and is before focusable inputs (we placed it in markup)
        if (fakeEmailAbsorb) {
          fakeEmailAbsorb.tabIndex = -1;
        }
        if (searchInput) {
          searchInput.value = '';
          searchInput.readOnly = true;

          const enableEditing = () => {
            try { searchInput.readOnly = false; } catch(e) {}
            if (searchInput.value && searchInput.value.includes('@')) searchInput.value = '';
          };
          searchInput.addEventListener('focus', enableEditing, { once:true });
          searchInput.addEventListener('mousedown', enableEditing, { once:true });
          searchInput.addEventListener('touchstart', enableEditing, { once:true });

          searchInput.addEventListener('focus', () => { if (searchInput.value && searchInput.value.includes('@')) searchInput.value = ''; });

          setTimeout(()=> {
            try {
              if (searchInput && searchInput.value && searchInput.value.includes('@')) searchInput.value = '';
              searchInput.readOnly = false;
            } catch(e) {}
          }, 450);

          window.addEventListener('pageshow', () => {
            try { if (searchInput) { searchInput.value = ''; searchInput.readOnly = false; } } catch(e){}
          });

          const obs = new MutationObserver(()=> {
            try { if (searchInput && searchInput.value && searchInput.value.includes('@')) searchInput.value = ''; } catch(e){}
          });
          obs.observe(searchInput, { attributes: true, attributeFilter: ['value'] });

          let guardCount = 0;
          const guardInterval = setInterval(()=> {
            if (!searchInput) { clearInterval(guardInterval); return; }
            if (searchInput.value && searchInput.value.includes('@')) searchInput.value = '';
            guardCount++;
            if (guardCount > 8) clearInterval(guardInterval);
          }, 700);
        }
      } catch(e) { console.warn('ensureSearchInputNotAutofilled err', e); }
    }

    // Handle buyModal compact toggle button
    if (buyScrollBtn) {
      buyScrollBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const modal = buyModalInner;
        if (!modal) return;
        const isCompact = modal.classList.toggle('compact');
        buyScrollBtn.textContent = isCompact ? 'D√©sactiver d√©filement' : 'Activer d√©filement';
        if (isCompact) modal.scrollTop = 0;
      });
    }

    // init load
    (async function init(){
      updateCartBadge();
      ensureSearchInputNotAutofilled();
      await loadCategories();
      await loadProducts(true);
    })();

  </script>

</body>
</html>

