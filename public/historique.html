<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Historique des commandes • MedicalShop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg-1:#061025; --bg-2:#07182a; --panel:#0f172a; --accent:#1f6feb; --accent-2:#22c55e;
      --muted:#94a3b8; --white:#e6eef8; --glass: rgba(255,255,255,0.04);
      --radius:12px; --shadow: 0 12px 30px rgba(0,0,0,.28);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:Inter,system-ui,Roboto,Arial; color:var(--white);
      background:linear-gradient(180deg,var(--bg-1),var(--bg-2)); }

    a{ color:inherit; text-decoration:none }
    button{ font:inherit }

    /* Header */
    header.top{
      position:sticky; top:0; z-index:50;
      display:flex; align-items:center; gap:12px; padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background:linear-gradient(180deg,#0a142b99,#0a142bcc);
      backdrop-filter:saturate(120%) blur(6px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:800; font-size:18px; min-width:0 }
    .logo{ width:40px;height:40px;border-radius:10px;display:grid;place-items:center;
      background:linear-gradient(135deg,var(--accent),var(--accent-2)); font-weight:900 }
    nav.topnav{ margin-left:auto; display:flex; gap:8px; align-items:center; }
    nav.topnav a{ color:var(--muted); padding:8px 10px; border-radius:8px }
    nav.topnav a:hover{ background:var(--glass); color:var(--white) }

    /* Mobile nav toggle (burger) */
    .nav-toggle{
      display:none; margin-left:auto; border:1px solid var(--glass); background:transparent;
      color:var(--white); padding:8px 10px; border-radius:10px; cursor:pointer;
      font-weight:800;
    }
    /* center the panel on mobile and don't take full width */
    .nav-panel{
      display:none; position:absolute; top:64px; z-index:60;
      background:linear-gradient(180deg,#0d1a36,#0b1630);
      border:1px solid var(--glass); border-radius:12px; box-shadow:var(--shadow); padding:6px;
      width:calc(100% - 48px); max-width:520px; left:50%; transform:translateX(-50%);
    }
    .nav-panel a{ display:block; padding:10px 12px; border-radius:10px; color:var(--white) }
    .nav-panel a:hover{ background:rgba(255,255,255,0.06) }

    /* Layout */
    .container{ max-width:1260px; margin:18px auto; padding:0 12px 18px; }
    .panel{ background:linear-gradient(180deg,var(--panel),#071428); border-radius:var(--radius);
      padding:14px; border:1px solid rgba(255,255,255,0.06); box-shadow:var(--shadow) }

    /* Controls */
    .controls{
      display:grid; grid-template-columns: 1fr 180px 200px auto; gap:10px;
      align-items:center; margin:12px 0;
    }
    .controls-inline{ display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
    input, select {
      width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.03); color:var(--white);
    }
    input::placeholder{ color:#9fb0c6 }
    .btn{ background:linear-gradient(135deg,var(--accent),#3ea1ff); border:0; color:white;
      padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer }
    .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.18); color:var(--muted) }
    .btn:disabled{ opacity:.6; cursor:not-allowed }

    /* Table */
    .table-wrap{ width:100%; overflow:auto; border-radius:12px; }
    .table{ width:100%; border-collapse:collapse; min-width:680px }
    .table th, .table td { text-align:left; padding:12px 10px; border-bottom:1px solid rgba(255,255,255,0.06) }
    .table th{ font-size:13px; color:var(--muted); font-weight:700 }
    .order-row{ display:flex; gap:12px; align-items:center }
    .small{ font-size:13px; color:var(--muted) }
    .status { padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px; display:inline-block }
    .status.pending{ background:rgba(255,255,255,0.06); color:var(--muted) }
    .status.confirmed{ background:linear-gradient(135deg,#18c38b,#10b981); color:white }
    .status.rejected, .status.cancelled{ background:linear-gradient(135deg,#ff6b6b,#ff8a5c); color:white }

    /* Pagination */
    .pagination{ display:flex; gap:8px; justify-content:flex-end; align-items:center; margin-top:12px }
    .diag{ color:#ffb86b; margin-top:8px }

    /* Modal */
    .modal-backdrop{ display:none; position:fixed; inset:0; place-items:center;
      background:rgba(0,0,0,0.6); z-index:200; padding:12px }
    .modal.panel{ max-width:980px; width:100%; max-height:90vh; overflow:auto; border-radius:12px; }
    .modal .content{ padding:14px; background:linear-gradient(180deg,var(--panel),#071428); border-radius:10px; border:1px solid rgba(255,255,255,0.04) }

    /* Small responsive */
    @media (max-width:980px){
      .table{ min-width:680px }
      .controls{ grid-template-columns: 1fr 1fr; }
      .controls .controls-inline{ grid-column:1 / -1; justify-content:flex-start }
    }

    @media (max-width:760px){
      .nav-toggle{ display:block }
      nav.topnav{ display:none }
      .container{ padding:0 10px 16px }
      .controls{ grid-template-columns:1fr; }
      .table-wrap{ overflow:visible; }
      .table{ border-collapse:separate; border-spacing:0 10px; min-width:0 }
      .table thead{ display:none }
      .table tr{ display:block; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:10px }
      .table td{ display:flex; justify-content:space-between; align-items:flex-start; gap:10px; border-bottom:0; padding:8px 6px }
      .table td::before{ content:attr(data-label); flex:0 0 120px; color:var(--muted); font-weight:700 }
      .order-row{ gap:10px }
      .pagination{ justify-content:center }
    }

    @media (max-width:380px){
      .logo{ width:36px;height:36px }
      .brand span{ display:none }
    }

    /* make the filterStatus options black & bold */
    select#filterStatus option { color: #000000; font-weight: 700; }

    /* focus */
    :focus-visible{ outline:2px solid #3ea1ff; outline-offset:2px; border-radius:8px }
  </style>
</head>
<body>
  <header class="top" role="banner">
    <div class="brand">
      <div class="logo">M+</div>
      <div style="line-height:1.1;min-width:0"><div style="font-weight:900">Historique des commandes</div>
        <div class="small">MedicalShop • admin</div></div>
    </div>

    <!-- mobile burger (replaces previous 'Menu' text) -->
    <button id="navToggle" class="nav-toggle" aria-controls="navPanel" aria-expanded="false" title="Menu">☰</button>

    <nav class="topnav" aria-label="Navigation principale">
      <a href="admin.html">← Dashboard</a>
      <a href="products_admin.html">Produits</a>
      <a href="index.html">Site public</a>
      <!-- moved "Historique" not necessary here since we're on it -->
    </nav>

    <div id="navPanel" class="nav-panel" role="dialog" aria-modal="true" aria-label="Menu">
      <a href="admin.html">← Dashboard</a>
      <a href="products_admin.html">Produits</a>
      <a href="index.html">Site public</a>
    </div>
  </header>

  <main class="container" role="main">
    <div class="panel">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap">
        <div>
          <h2 style="margin:0">Historique des commandes</h2>
          <div class="small" style="color:var(--muted); margin-top:6px">Liste des transactions — actions : valider / rejeter</div>
        </div>
      </div>

      <div class="controls" style="margin-top:12px">
        <input id="search" placeholder="Recherche ID, order_number ou nom client..." aria-label="Recherche"/>
        <select id="filterStatus" aria-label="Filtrer par statut">
          <option value="">Tous statuts</option>
          <option value="pending">pending</option>
          <option value="confirmed">confirmed</option>
          <option value="cancelled">cancelled</option>
        </select>

        <!-- Date filter (remplace le bouton Export PDF) -->
        <div style="display:flex; gap:6px; align-items:center;">
          <input id="dateFrom" type="date" aria-label="Date depuis" style="width:50%" />
          <input id="dateTo" type="date" aria-label="Date jusqu'à" style="width:50%" />
        </div>

        <div class="controls-inline">
          <button id="btnApply" class="btn ghost">Appliquer</button>
          <button id="btnExportCsv" class="btn ghost">Exporter CSV</button>
        </div>
      </div>

      <div class="table-wrap" role="region" aria-label="Tableau des commandes" tabindex="0">
        <table class="table" role="table" aria-label="Historique commandes">
          <thead>
            <tr>
              <th scope="col">ID</th>
              <th scope="col">Client</th>
              <th scope="col">Montant</th>
              <th scope="col">Statut</th>
              <th scope="col">Créé</th>
              <th scope="col" style="text-align:right">Actions</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6">Chargement…</td></tr>
          </tbody>
        </table>
      </div>

      <div class="pagination" style="margin-top:12px">
        <div id="pagerInfo" class="small muted"></div>
        <button id="prevPage" class="btn ghost" aria-label="Page précédente">Préc</button>
        <button id="nextPage" class="btn ghost" aria-label="Page suivante">Suiv</button>
      </div>

      <div id="diag" class="diag" role="status" aria-live="polite"></div>
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" aria-hidden="true">
    <div class="modal panel">
      <div class="content">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px; position:sticky; top:0; background:transparent; padding-bottom:6px">
          <h3 id="modalTitle" style="margin:0">Détails commande</h3>
          <button id="modalClose" class="btn ghost" aria-label="Fermer">Fermer</button>
        </div>
        <div id="modalContent" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    /* ---------- CONFIG ---------- */
    const SUPABASE_URL = "https://vrzmowqzegmaymewmbij.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZyem1vd3F6ZWdtYXltZXdtYmlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzMDMwNzksImV4cCI6MjA3MDg3OTA3OX0.TmkdqXhkVgbfhAWVj-qLC9bDTL0-_YoGz-SgS81sNG0";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ---------- NAV (mobile) ---------- */
    const navToggle = document.getElementById('navToggle');
    const navPanel = document.getElementById('navPanel');
    if (navToggle && navPanel) {
      const setOpen = (open)=> {
        navPanel.style.display = open ? 'block' : 'none';
        navToggle.setAttribute('aria-expanded', String(open));
        if (open) {
          const first = navPanel.querySelector('a'); first && first.focus({preventScroll:true});
        }
      };
      navToggle.addEventListener('click',(e)=>{ e.stopPropagation(); setOpen(navPanel.style.display!=='block'); });
      document.addEventListener('click',(e)=>{ if (navPanel.style.display==='block' && !navPanel.contains(e.target) && e.target !== navToggle) setOpen(false) });
      window.addEventListener('resize',()=>{ if (window.matchMedia('(min-width: 761px)').matches) setOpen(false); });
      document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') setOpen(false); });
    }

    /* ---------- DOM refs ---------- */
    const $ = s => document.querySelector(s);
    const tbody = $("#tbody");
    const search = $("#search");
    const filterStatus = $("#filterStatus");
    const dateFrom = $("#dateFrom");
    const dateTo = $("#dateTo");
    const btnApply = $("#btnApply");
    const prevPage = $("#prevPage");
    const nextPage = $("#nextPage");
    const pagerInfo = $("#pagerInfo");
    const btnExportCsv = $("#btnExportCsv");
    const diag = $("#diag");

    const modal = $("#modal");
    const modalContent = $("#modalContent");
    const modalClose = $("#modalClose");

    let page = 0;
    let per = 20;
    let totalCount = 0;
    let loading = false;

    function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
    function fmtNumber(n){ return Number(n||0).toLocaleString('fr-FR'); }

    /* ---------- Build filters helper ---------- */
    function applyFiltersToQuery(qb, { q, status, fromDate, toDate }) {
      // search on order_number or order_name
      if (q) {
        // supabase .or with ilike on multiple columns
        qb = qb.or(`order_number.ilike.%${q}%,order_name.ilike.%${q}%`);
      }
      if (status) qb = qb.eq('status', status);
      if (fromDate) qb = qb.gte('created_at', fromDate);
      if (toDate) qb = qb.lte('created_at', toDate + 'T23:59:59'); // include full day
      return qb;
    }

    /* ---------- Rendering row (no thumbnails) ---------- */
    function trOrderRow(o) {
      const when = new Date(o.created_at || o.placed_at || Date.now()).toLocaleString();
      const statusClass = o.status === 'pending' ? 'pending' : (o.status === 'confirmed' ? 'confirmed' : (o.status === 'cancelled' ? 'cancelled' : 'rejected'));
      const totalVal = Number(o.total ?? o.total_amount ?? 0).toLocaleString('fr-FR');
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td data-label="ID"><div style="font-weight:800">${escapeHtml(String(o.id).slice(0,16))}</div><div class="small">${escapeHtml(String(o.order_number || ''))}</div></td>
         <td data-label="Client">${escapeHtml(o.order_name || o.customer_email || o.user_email || 'Client anonyme')}</td>
         <td data-label="Montant">${escapeHtml(totalVal)} ${escapeHtml(o.currency || 'XOF')}</td>
         <td data-label="Statut"><span class="status ${statusClass}">${escapeHtml(o.status||'')}</span></td>
         <td data-label="Créé" class="small">${escapeHtml(when)}</td>
         <td data-label="Actions" style="text-align:right">
           <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
             <button class="btn ghost btn-view" data-id="${escapeHtml(o.id)}">Voir</button>
             ${o.status === 'pending'
               ? `<button class="btn btn-accept" data-id="${escapeHtml(o.id)}">Valider</button>
                  <button class="btn ghost btn-reject" data-id="${escapeHtml(o.id)}">Rejeter</button>` : ''}
           </div>
         </td>`;
      return tr;
    }

    function attachRowHandlers(){
      tbody.querySelectorAll('.btn-accept').forEach(b => b.addEventListener('click', async (e) => {
        if (!confirm('Valider cette commande ?')) return;
        await changeOrderStatus(e.currentTarget.dataset.id, 'confirmed');
      }));
      tbody.querySelectorAll('.btn-reject').forEach(b => b.addEventListener('click', async (e) => {
        if (!confirm('Rejeter cette commande ?')) return;
        await changeOrderStatus(e.currentTarget.dataset.id, 'cancelled');
      }));
      tbody.querySelectorAll('.btn-view').forEach(b => b.addEventListener('click', async (e) => {
        await showOrderDetailModal(e.currentTarget.dataset.id);
      }));
    }

    /* ---------- Load page (with full-count for filters) ---------- */
    async function loadPage() {
      if (loading) return;
      loading = true;
      tbody.innerHTML = '<tr><td colspan="6">Chargement…</td></tr>';
      diag.textContent = '';
      per = Number(20); // page size fixed at 20 (kept from before)

      const qText = (search.value || '').trim();
      const status = (filterStatus.value || '').trim();
      const fromDate = (dateFrom.value || '').trim();
      const toDate = (dateTo.value || '').trim();

      try {
        // 1) get total count matching filters (head:true returns no rows but count)
        let countQb = supabase.from('orders').select('id', { count: 'exact', head: true });
        countQb = applyFiltersToQuery(countQb, { q: qText, status, fromDate, toDate });
        const countRes = await countQb;
        if (countRes.error) {
          console.warn('count fetch err', countRes.error);
          // fallback: set totalCount to 0 and continue
          totalCount = 0;
        } else {
          totalCount = countRes.count ?? 0;
        }

        // clamp page if needed
        const maxPage = Math.max(0, Math.ceil((totalCount||0) / per) - 1);
        if (page > maxPage) page = maxPage;

        // 2) fetch page of orders (with order_items included, so we can show items details but WITHOUT images)
        let from = page * per;
        let to = from + per - 1;
        let dataQb = supabase.from('orders').select('*, order_items(*)', { count: 'exact' }).order('created_at', { ascending: false }).range(from, to);
        dataQb = applyFiltersToQuery(dataQb, { q: qText, status, fromDate, toDate });
        const ordersRes = await dataQb;
        if (ordersRes.error) throw ordersRes.error;
        let data = ordersRes.data || [];

        // Render rows
        if (!data.length) {
          tbody.innerHTML = '<tr><td colspan="6">Aucun résultat</td></tr>';
        } else {
          tbody.innerHTML = '';
          data.forEach(o => tbody.appendChild(trOrderRow(o)));
        }

        // update pager info & controls
        pagerInfo.textContent = `Page ${page+1} — ${totalCount} résultat${totalCount>1?'s':''}`;
        updatePagerButtons();
        attachRowHandlers();
      } catch (err) {
        console.error('loadPage err', err);
        diag.textContent = 'Erreur de chargement (voir console).';
        tbody.innerHTML = '<tr><td colspan="6">Erreur</td></tr>';
      } finally {
        loading = false;
      }
    }

    function updatePagerButtons(){
      const maxPage = Math.max(0, Math.ceil((totalCount||0)/per) - 1);
      prevPage.disabled = page <= 0;
      nextPage.disabled = page >= maxPage;
    }

    /* ---------- Modal (no images) ---------- */
    async function showOrderDetailModal(orderId){
      try {
        const { data: nestedData, error: nestedErr } = await supabase.from('orders').select('*, order_items(*)').eq('id', orderId).single();
        if (nestedErr || !nestedData) {
          alert('Impossible de charger la commande (voir console).');
          console.warn(nestedErr);
          return;
        }
        const order = nestedData;
        const items = order.order_items || [];

        // Build HTML (no images). We'll show product_id, qty, price_at_order.
        const totalVal = Number(order.total ?? order.total_amount ?? 0).toLocaleString('fr-FR');
        let html = `<div style="display:flex;gap:14px;align-items:flex-start;flex-wrap:wrap;">
          <div style="flex:1 1 480px; min-width:260px">
            <div style="background:transparent;padding:6px;border-radius:8px">
              <div style="font-weight:900; font-size:18px">#${escapeHtml((order.id||'').toString().slice(0,16))}</div>
              <div class="small" style="margin-top:6px">${escapeHtml(new Date(order.created_at||order.placed_at||Date.now()).toLocaleString())}</div>
              <div style="margin-top:8px" class="small">Client: <strong>${escapeHtml(order.order_name || order.customer_email || 'Client anonyme')}</strong></div>
              <div class="small">Téléphone: ${escapeHtml(order.phone || '')}</div>
              <div class="small">Order #: ${escapeHtml(order.order_number || '')}</div>
              <div style="margin-top:8px; font-weight:800">Total: ${escapeHtml(totalVal)} ${escapeHtml(order.currency||'XOF')}</div>
              <div class="small">Statut: ${escapeHtml(order.status || '')}</div>
              <div class="small">Adresse: ${escapeHtml(order.shipping_address || '')}</div>
            </div>
          </div>

          <div style="flex:0 0 320px; min-width:240px; display:flex; flex-direction:column; gap:10px;">
            <h4 style="margin:6px 0 8px 0">Articles</h4>
            <div style="display:flex;flex-direction:column;gap:8px; max-height:360px; overflow:auto">`;

        // If order_items contains item data (qty, price_at_order), show that. We won't attempt to fetch product names here.
        (items || []).forEach(it => {
          html += `<div style="display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,0.04)">
              <div style="flex:1">
                <div style="font-weight:700">Produit ID: ${escapeHtml(String(it.product_id||''))}</div>
                <div class="small">Quantité: ${escapeHtml(String(it.quantity || 1))} — Prix/unité: ${escapeHtml(String(it.price_at_order || it.price || ''))}</div>
                <div class="small">Statut item: ${escapeHtml(it.status || 'pending')}</div>
              </div>
            </div>`;
        });

        html += `</div></div></div>`;
        modalContent.innerHTML = html;
        showModal(true);
      } catch (err) {
        console.error('showOrderDetailModal err', err);
        alert('Impossible de charger les détails (voir console).');
      }
    }

    function showModal(show){
      modal.style.display = show ? 'grid' : 'none';
      modal.setAttribute('aria-hidden', show ? 'false' : 'true');
      if (show) modal.querySelector('#modalClose')?.focus({preventScroll:true});
    }
    modalClose.addEventListener('click', ()=> showModal(false));
    modal.addEventListener('click',(e)=>{ if (e.target === modal) showModal(false); });
    document.addEventListener('keydown',(e)=>{ if (e.key === 'Escape' && modal.getAttribute('aria-hidden')==='false') showModal(false); });

    /* ---------- Status change ---------- */
    async function changeOrderStatus(orderId, newStatus){
      try {
        const { error: e1 } = await supabase.from('orders').update({ status: newStatus }).eq('id', orderId);
        if (e1) throw e1;
        try { await supabase.from('order_items').update({ status: newStatus }).eq('order_id', orderId); } catch(_) {}
        await loadPage();
      } catch (err) {
        console.error('changeOrderStatus err', err);
        alert('Erreur changement statut (voir console)');
      }
    }

    /* ---------- Export CSV (applies the same filters as loadPage across the selected page range or entire filtered set) ---------- */
    async function exportCsv() {
      try {
        const qText = (search.value || '').trim();
        const status = (filterStatus.value || '').trim();
        const fromDate = (dateFrom.value || '').trim();
        const toDate = (dateTo.value || '').trim();

        // Get all matching rows (we'll fetch up to a large limit; if you expect > 10k rows adapt)
        const perFetch = 1000;
        let rows = [];
        let start = 0;
        while (true) {
          let qb = supabase.from('orders').select('*').order('created_at', { ascending: false }).range(start, start + perFetch - 1);
          qb = applyFiltersToQuery(qb, { q: qText, status, fromDate, toDate });
          const res = await qb;
          if (res.error) throw res.error;
          const data = res.data || [];
          rows = rows.concat(data);
          if (!data || data.length < perFetch) break;
          start += perFetch;
          // safety cap to avoid infinite loop
          if (rows.length > 20000) break;
        }

        if (!rows.length) { alert('Aucune donnée à exporter'); return; }

        const csvRows = [
          ['id','order_number','order_name','status','total','currency','created_at','shipping_address']
        ];
        for (const r of rows) {
          csvRows.push([
            `"${String(r.id).replace(/"/g,'""')}"`,
            `"${String(r.order_number||'').replace(/"/g,'""')}"`,
            `"${String(r.order_name||'').replace(/"/g,'""')}"`,
            `"${String(r.status||'').replace(/"/g,'""')}"`,
            `"${String(r.total ?? r.total_amount ?? 0)}"`,
            `"${String(r.currency||'XOF')}"`,
            `"${String(r.created_at||'')}"`,
            `"${String(r.shipping_address||'').replace(/"/g,'""')}"`
          ]);
        }

        const csv = csvRows.map(r => r.join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `orders_export_${Date.now()}.csv`; a.click();
        URL.revokeObjectURL(url);
      } catch (err) {
        console.error('exportCsv err', err);
        alert('Erreur export CSV (voir console).');
      }
    }

    /* ---------- Events ---------- */
    btnApply.addEventListener('click', ()=> { page = 0; loadPage(); });
    prevPage.addEventListener('click', ()=> { if (page>0) { page--; loadPage(); }});
    nextPage.addEventListener('click', ()=> { page++; loadPage(); });
    btnExportCsv.addEventListener('click', exportCsv);
    search.addEventListener('keydown', (e)=> { if (e.key === 'Enter') { page = 0; loadPage(); } });

    /* ---------- Init ---------- */
    (async function init(){
      try {
        // optional auth check (previous behavior kept)
        try {
          const { data } = await supabase.auth.getUser();
          // If you want to redirect on missing auth, keep the following:
          // if (!data?.user) { window.location.href = 'admin-login.html'; return; }
        } catch (e) { /* ignore auth check errors here to avoid redirect loops */ }

        await loadPage();
      } catch (err) {
        console.error('init err', err);
      }
    })();
  </script>
</body>
</html>
